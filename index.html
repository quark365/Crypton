<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoVis: Dual-Channel RSA+AES+ECDH</title>
    
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- QR Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'JetBrains Mono', monospace; background-color: #0f172a; color: #e2e8f0; }
        .glass { background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(148, 163, 184, 0.1); }
        .scan-line {
            width: 100%; height: 2px; background: #06b6d4; position: absolute;
            animation: scan 2s linear infinite; box-shadow: 0 0 10px #06b6d4;
        }
        @keyframes scan { 0% { top: 0%; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        .matrix-bg {
            background-image: linear-gradient(rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.9)), url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%231e293b' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .fingerprint { font-size: 2.5rem; letter-spacing: 0.5rem; text-shadow: 0 0 15px rgba(255,255,255,0.3); }
        .btn-primary { @apply bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-4 rounded-xl transition-all shadow-lg shadow-cyan-900/50 flex items-center justify-center gap-2; }
        .btn-secondary { @apply bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-xl transition-all flex items-center justify-center gap-2; }
        
        /* Glitch animation for Darth Mode */
        .glitch { animation: glitch 1s linear infinite; }
        @keyframes glitch {
            2%, 64% { transform: translate(2px,0) skew(0deg); }
            4%, 60% { transform: translate(-2px,0) skew(0deg); }
            62% { transform: translate(0,0) skew(5deg); }
        }
        .terminal-text { font-family: 'Courier New', monospace; }
    </style>
</head>
<body class="matrix-bg min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const Icon = ({ p, size=24, className="" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {p}
            </svg>
        );
        const icons = {
            shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />,
            key: <><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/><circle cx="7.5" cy="15.5" r="5.5"/></>,
            qr: <><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><path d="M10 7h4"/><path d="M7 10v4"/><path d="M14 10h4"/></>,
            cam: <><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></>,
            send: <><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>,
            sound: <><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></>,
            user: <><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
            skull: <path d="M12 22s4-2 4-7V9c0-5-8-5-8 0v6c0 5 4 7 4 7z"/>,
            bomb: <><circle cx="12" cy="13" r="9"/><path d="M12 4V2"/><path d="M20 13h2"/><path d="M12 22v2"/><path d="M4 13H2"/></>
        };

        // --- CRYPTO HELPERS ---
        const buf2hex = (buf) => [...new Uint8Array(buf)].map(x => x.toString(16).padStart(2, '0')).join('');
        const hex2buf = (hex) => new Uint8Array(hex.match(/.{1,2}/g).map(byte => parseInt(byte, 16))).buffer;

        // --- FINGERPRINT GENERATOR ---
        const generateFingerprint = async (buffer) => {
            const hash = await window.crypto.subtle.digest('SHA-256', buffer);
            const arr = new Uint8Array(hash);
            const emojis = ["ğŸ¶","ğŸ±","ğŸ­","ğŸ¹","ğŸ°","ğŸ¦Š","ğŸ»","ğŸ¼","ğŸ¨","ğŸ¯","ğŸ¦","ğŸ®","ğŸ·","ğŸ¸","ğŸµ","ğŸ”","ğŸ§","ğŸ¦","ğŸ¤","ğŸ¦†","ğŸ¦…","ğŸ¦‰","ğŸ¦‡","ğŸº","ğŸ—","ğŸ´","ğŸ¦„","ğŸ","ğŸ›","ğŸ¦‹","ğŸŒ","ğŸ","ğŸœ","ğŸ•·","ğŸ•¸","ğŸ¢","ğŸ","ğŸ¦","ğŸ¦‚","ğŸ¦€","ğŸ¦‘","ğŸ™","ğŸ¦","ğŸ ","ğŸŸ","ğŸ¡","ğŸ¬","ğŸ¦ˆ","ğŸ³","ğŸ‹","ğŸŠ","ğŸ†","ğŸ…","ğŸƒ","ğŸ‚","ğŸ„","ğŸª","ğŸ«","ğŸ˜","ğŸ¦","ğŸ¦","ğŸ","ğŸ–","ğŸ","ğŸ","ğŸ‘","ğŸ•","ğŸ©","ğŸˆ","ğŸ“","ğŸ¦ƒ","ğŸ•Š","ğŸ‡","ğŸ","ğŸ€","ğŸ¿","ğŸ¾","ğŸ‰","ğŸ²","ğŸŒµ","ğŸ„","ğŸŒ²","ğŸŒ³","ğŸŒ´"];
            let fp = "";
            for(let i=0; i<4; i++) fp += emojis[arr[i] % emojis.length];
            return fp;
        };

        // --- COMPONENTS ---
        const QRDisplay = ({ data, label, subLabel, isToxic }) => {
            const canvasRef = useRef(null);
            useEffect(() => {
                if (canvasRef.current && data) {
                    new QRious({ element: canvasRef.current, value: data, size: 220, level: 'L', foreground: isToxic ? '#ef4444' : 'black' });
                }
            }, [data, isToxic]);
            return (
                <div className={`bg-white p-4 rounded-2xl flex flex-col items-center shadow-xl ${isToxic ? 'border-4 border-red-600' : ''}`}>
                    <canvas ref={canvasRef} />
                    <p className={`font-bold text-sm mt-2 ${isToxic ? 'text-red-600 uppercase' : 'text-black'}`}>{label}</p>
                    {subLabel && <p className="text-slate-500 text-[10px] font-mono mt-1 text-center max-w-[200px] break-all">{subLabel}</p>}
                </div>
            );
        };

        const QRScanner = ({ onScan, onClose }) => {
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const [error, setError] = useState("");

            useEffect(() => {
                let stream;
                navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                    .then(s => {
                        stream = s;
                        if (videoRef.current) {
                            videoRef.current.srcObject = s;
                            videoRef.current.play();
                            requestAnimationFrame(tick);
                        }
                    })
                    .catch(() => setError("Camera blocked. Please use HTTPS or Localhost."));

                const tick = () => {
                    if (videoRef.current && videoRef.current.readyState === 4) {
                        const cvs = canvasRef.current;
                        const vid = videoRef.current;
                        cvs.width = vid.videoWidth;
                        cvs.height = vid.videoHeight;
                        const ctx = cvs.getContext("2d");
                        ctx.drawImage(vid, 0, 0);
                        const img = ctx.getImageData(0, 0, cvs.width, cvs.height);
                        const code = jsQR(img.data, img.width, img.height);
                        if (code) { onScan(code.data); return; }
                    }
                    requestAnimationFrame(tick);
                };
                return () => stream?.getTracks().forEach(t => t.stop());
            }, []);

            return (
                <div className="fixed inset-0 z-50 bg-black/95 flex flex-col items-center justify-center p-4">
                    <div className="relative w-full max-w-sm aspect-square bg-slate-900 rounded-2xl overflow-hidden border-2 border-cyan-500 shadow-[0_0_30px_rgba(6,182,212,0.3)]">
                        <video ref={videoRef} className="absolute inset-0 w-full h-full object-cover" playsInline />
                        <canvas ref={canvasRef} className="hidden" />
                        <div className="scan-line"></div>
                        {error && <div className="absolute inset-0 flex items-center justify-center text-red-400 font-bold bg-black/80 text-center p-6">{error}</div>}
                    </div>
                    <button onClick={onClose} className="mt-8 bg-slate-800 text-white px-8 py-3 rounded-full font-bold hover:bg-slate-700 transition-colors">Cancel</button>
                </div>
            );
        };

        const HackingTerminal = ({ targetType, onClose }) => {
            const [logs, setLogs] = useState(["> INITIALIZING INTERCEPTION..."]);
            const [progress, setProgress] = useState(0);
            const [cracking, setCracking] = useState(true);
            const [hexDump, setHexDump] = useState("");

            useEffect(() => {
                if(!cracking) return;
                const interval = setInterval(() => {
                    let hex = "";
                    for(let i=0; i<8; i++) hex += Math.floor(Math.random()*16).toString(16);
                    setHexDump(prev => (prev + " " + hex).slice(-200));
                }, 50);
                return () => clearInterval(interval);
            }, [cracking]);

            useEffect(() => {
                const steps = targetType === 'IDENTITY' 
                    ? [
                        "Captured Public Key Block...",
                        "Calculating Elliptic Curve Order...",
                        "Running Pollard's Rho Algorithm...",
                        "Attempting Discrete Logarithm Attack...",
                        "Brute forcing Private Scalar...",
                        "Complexity: 2^128 operations required...",
                        "Estimated time: 4 Billion Years...",
                        "FAILED: Key is mathematically secure."
                      ]
                    : [
                        "Captured Encrypted Packet...",
                        "Analyzing Header: AES-256-GCM...",
                        "Extracting IV and Auth Tag...",
                        "Attempting Dictionary Attack on Key...",
                        "Checking for Weak Randomness...",
                        "Brute Forcing Key Space (2^256)...",
                        "Progress: 0.0000000000001%...",
                        "FAILED: Missing Private Key."
                      ];

                let stepIndex = 0;
                const timer = setInterval(() => {
                    if (stepIndex < steps.length) {
                        setLogs(prev => [...prev, `> ${steps[stepIndex]}`]);
                        setProgress(((stepIndex + 1) / steps.length) * 100);
                        stepIndex++;
                    } else {
                        clearInterval(timer);
                        setCracking(false);
                    }
                }, 800);

                return () => clearInterval(timer);
            }, [targetType]);

            return (
                <div className="fixed inset-0 z-50 bg-black/95 flex flex-col items-center justify-center p-4 font-mono">
                    <div className="w-full max-w-lg bg-slate-900 border-2 border-red-600 rounded-xl overflow-hidden shadow-[0_0_50px_rgba(220,38,38,0.5)]">
                        <div className="bg-red-900/30 p-3 border-b border-red-600 flex justify-between items-center">
                            <span className="text-red-500 font-bold animate-pulse">â˜ ï¸ CRYPTANALYSIS SUITE</span>
                            <span className="text-xs text-red-400">{targetType} TARGET</span>
                        </div>
                        <div className="h-64 p-4 overflow-y-auto space-y-2 font-mono text-xs text-green-400 bg-black">
                            {logs.map((l, i) => <div key={i}>{l}</div>)}
                            {cracking && <div className="animate-pulse">_</div>}
                        </div>
                        <div className="h-20 bg-slate-800 p-2 text-[10px] text-slate-500 font-mono overflow-hidden opacity-50 break-all">
                            RAW_STREAM: {hexDump}
                        </div>
                        <div className="p-4 bg-slate-900 border-t border-red-900/50">
                            {!cracking && (
                                <div className="text-center">
                                    <div className="text-red-500 font-bold mb-2">ENCRYPTION UNBROKEN</div>
                                    <p className="text-xs text-slate-400 mb-4">Without the private key or shared secret, this data is random noise.</p>
                                    <button onClick={() => onClose()} className="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-lg">
                                        CLOSE TERMINAL
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APPLICATION ---
        const App = () => {
            // Identity State
            const [isDarth, setIsDarth] = useState(false);
            const [activeTab, setActiveTab] = useState('CONNECT'); // CONNECT, VERIFY, CHAT
            
            // My Keys (Alice/Bob)
            const [myKeyPair, setMyKeyPair] = useState(null);
            const [myPublicString, setMyPublicString] = useState(""); 
            const [sharedSecretKey, setSharedSecretKey] = useState(null); 
            const [sharedFingerprint, setSharedFingerprint] = useState("????");
            
            // Darth State
            const [darthFakeMessage, setDarthFakeMessage] = useState("Fake Message");
            const [darthFakePacket, setDarthFakePacket] = useState(null);
            const [hackTarget, setHackTarget] = useState(null); // 'IDENTITY' or 'MESSAGE'

            // UI State
            const [scannerMode, setScannerMode] = useState(null); // 'KEY', 'MESSAGE', 'DARTH_INTERCEPT'
            const [message, setMessage] = useState("");
            const [packetDisplay, setPacketDisplay] = useState(null);
            const [chatLog, setChatLog] = useState([]);
            const [logs, setLogs] = useState([]);

            const log = (m) => setLogs(p => [`> ${m}`, ...p]);

            // 1. Generate ECDH Identity (Alice/Bob)
            const generateIdentity = async () => {
                try {
                    const keys = await window.crypto.subtle.generateKey(
                        { name: "ECDH", namedCurve: "P-256" },
                        true, ["deriveKey", "deriveBits"]
                    );
                    const exported = await window.crypto.subtle.exportKey("spki", keys.publicKey);
                    const str = btoa(String.fromCharCode(...new Uint8Array(exported)));
                    setMyKeyPair(keys);
                    setMyPublicString(str);
                    setSharedSecretKey(null);
                    setSharedFingerprint("????");
                    setActiveTab('CONNECT');
                } catch (e) { console.error(e); }
            };

            useEffect(() => { generateIdentity(); }, []);

            // 2. Key Exchange (Alice/Bob)
            const handleScannedPublicKey = async (partnerKeyStr) => {
                try {
                    const binaryDer = Uint8Array.from(atob(partnerKeyStr), c => c.charCodeAt(0));
                    const partnerKey = await window.crypto.subtle.importKey(
                        "spki", binaryDer.buffer, { name: "ECDH", namedCurve: "P-256" }, true, []
                    );
                    const derivedKey = await window.crypto.subtle.deriveKey(
                        { name: "ECDH", public: partnerKey },
                        myKeyPair.privateKey,
                        { name: "AES-GCM", length: 256 },
                        true, ["encrypt", "decrypt"]
                    );
                    const rawKey = await window.crypto.subtle.exportKey("raw", derivedKey);
                    const fp = await generateFingerprint(rawKey);
                    setSharedSecretKey(derivedKey);
                    setSharedFingerprint(fp);
                    setActiveTab('VERIFY');
                } catch (e) { alert("Invalid Key Scanned"); }
            };

            // 3. Encrypt Message (Alice/Bob)
            const encryptMessage = async () => {
                if (!sharedSecretKey) return;
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const enc = new TextEncoder();
                const encryptedContent = await window.crypto.subtle.encrypt(
                    { name: "AES-GCM", iv }, sharedSecretKey, enc.encode(message)
                );
                const packet = JSON.stringify({ iv: buf2hex(iv), d: buf2hex(encryptedContent) });
                setPacketDisplay(packet);
                setChatLog(p => [...p, { sender: 'Me', text: message }]);
                setMessage("");
            };

            // 4. Decrypt Message (Alice/Bob)
            const decryptMessage = async (packetStr) => {
                if (!sharedSecretKey) {
                    alert("No secure connection! Scan keys first.");
                    return;
                }
                try {
                    const pkt = JSON.parse(packetStr);
                    const dec = await window.crypto.subtle.decrypt(
                        { name: "AES-GCM", iv: hex2buf(pkt.iv) }, sharedSecretKey, hex2buf(pkt.d)
                    );
                    const text = new TextDecoder().decode(dec);
                    setChatLog(p => [...p, { sender: 'Partner', text: text }]);
                    alert(`New Message: ${text}`);
                } catch (e) { 
                    alert("âŒ AUTHENTICITY CHECK FAILED\n\nThis packet was NOT encrypted with the verified shared key.\nPossible spoofing attempt detected.");
                }
            };

            // 5. Darth: Generate Fake QR
            const generateFakePacket = async () => {
                // Darth uses a random key because he doesn't know the shared secret
                const randomKey = await window.crypto.subtle.generateKey({ name: "AES-GCM", length: 256 }, true, ["encrypt"]);
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const enc = new TextEncoder();
                const encryptedContent = await window.crypto.subtle.encrypt(
                    { name: "AES-GCM", iv }, randomKey, enc.encode(darthFakeMessage)
                );
                const packet = JSON.stringify({ iv: buf2hex(iv), d: buf2hex(encryptedContent) });
                setDarthFakePacket(packet);
            };

            const onScan = (data) => {
                setScannerMode(null);
                // Darth Interception Logic
                if (isDarth) {
                    // Simple heuristic to decide visualization
                    setHackTarget(data.includes('"iv":') ? 'MESSAGE' : 'IDENTITY');
                    return;
                }
                // Normal Logic
                if (data.includes('"iv":')) decryptMessage(data);
                else handleScannedPublicKey(data);
            };

            // --- RENDER ---
            return (
                <div className={`min-h-screen flex flex-col ${isDarth ? 'border-4 border-red-900 bg-slate-950' : ''}`}>
                    
                    {/* Header */}
                    <header className={`p-4 border-b flex justify-between items-center shadow-lg z-10 ${isDarth ? 'bg-red-950 border-red-800' : 'bg-slate-900 border-slate-700'}`}>
                        <div className="flex items-center gap-3">
                            <div className={`p-2 rounded-lg ${isDarth ? 'bg-red-500/20 text-red-500' : 'bg-cyan-500/20 text-cyan-400'}`}>
                                <Icon p={isDarth ? icons.skull : icons.shield} size={28} />
                            </div>
                            <div>
                                <h1 className={`font-bold leading-tight ${isDarth ? 'text-red-500' : 'text-white'}`}>CryptoVis <span className="opacity-50 text-xs">v3.0</span></h1>
                                <div className="text-[10px] opacity-70 text-white">{isDarth ? 'DARTH ATTACKER MODE' : 'ECDH + AES Secure'}</div>
                            </div>
                        </div>
                        <label className="flex items-center gap-2 text-xs text-white cursor-pointer select-none bg-white/10 px-3 py-1 rounded-full">
                            <input type="checkbox" checked={isDarth} onChange={(e) => setIsDarth(e.target.checked)} className="accent-red-500"/>
                            {isDarth ? 'Exit Darth Mode' : 'Enter Darth Mode'}
                        </label>
                    </header>

                    {/* DARTH INTERFACE */}
                    {isDarth ? (
                        <main className="flex-1 p-4 max-w-md mx-auto w-full space-y-6 overflow-y-auto">
                            
                            {/* 1. Intercept Module */}
                            <div className="glass p-6 rounded-xl border border-red-800/50 shadow-[0_0_30px_rgba(220,38,38,0.1)]">
                                <h2 className="text-red-500 font-bold mb-4 flex items-center gap-2 text-lg">
                                    <Icon p={icons.cam} /> 1. INTERCEPT SIGNAL
                                </h2>
                                <p className="text-red-300/60 text-sm mb-4">Scan any QR Code (Key or Message) to attempt cryptanalysis.</p>
                                <button onClick={()=>setScannerMode('DARTH_INTERCEPT')} className="w-full bg-red-900/50 hover:bg-red-900 border border-red-700 text-red-100 py-4 rounded-xl font-bold flex items-center justify-center gap-2 transition-all">
                                    ACTIVATE SNIFFER
                                </button>
                            </div>

                            {/* 2. Spoof Module */}
                            <div className="glass p-6 rounded-xl border border-red-800/50">
                                <h2 className="text-red-500 font-bold mb-4 flex items-center gap-2 text-lg">
                                    <Icon p={icons.bomb} /> 2. INJECT FAKE PACKET
                                </h2>
                                <p className="text-red-300/60 text-sm mb-4">Generate a message. Since you lack the Shared Key, this packet will fail verification.</p>
                                
                                <div className="space-y-3">
                                    <input 
                                        value={darthFakeMessage}
                                        onChange={e=>setDarthFakeMessage(e.target.value)}
                                        className="w-full bg-black/50 border border-red-900 rounded p-3 text-red-100 placeholder-red-900 outline-none focus:border-red-500"
                                        placeholder="Enter Malicious Payload"
                                    />
                                    <button onClick={generateFakePacket} className="w-full bg-red-600 hover:bg-red-500 text-white py-3 rounded-lg font-bold shadow-lg shadow-red-900/50">
                                        GENERATE TOXIC QR
                                    </button>
                                </div>

                                {darthFakePacket && (
                                    <div className="mt-6 flex justify-center animate-in fade-in slide-in-from-bottom-4">
                                        <QRDisplay data={darthFakePacket} label="TOXIC PAYLOAD" subLabel="Authenticity: INVALID" isToxic={true} />
                                    </div>
                                )}
                            </div>
                        </main>
                    ) : (
                        /* STANDARD USER INTERFACE (Alice/Bob) */
                        <>
                            {/* Tabs */}
                            <div className="flex bg-slate-900/50 border-b border-slate-700">
                                <button onClick={()=>setActiveTab('CONNECT')} className={`flex-1 py-3 font-bold text-sm transition-colors ${activeTab==='CONNECT'?'text-cyan-400 border-b-2 border-cyan-400 bg-slate-800/30':'text-slate-500 hover:text-slate-300'}`}>1. Connect</button>
                                <button onClick={()=>setActiveTab('VERIFY')} className={`flex-1 py-3 font-bold text-sm transition-colors ${activeTab==='VERIFY'?'text-cyan-400 border-b-2 border-cyan-400 bg-slate-800/30':'text-slate-500 hover:text-slate-300'}`}>2. Verify</button>
                                <button onClick={()=>setActiveTab('CHAT')} className={`flex-1 py-3 font-bold text-sm transition-colors ${activeTab==='CHAT'?'text-cyan-400 border-b-2 border-cyan-400 bg-slate-800/30':'text-slate-500 hover:text-slate-300'}`}>3. Transfer</button>
                            </div>

                            <main className="flex-1 p-4 max-w-md mx-auto w-full space-y-6">
                                {/* TAB 1: CONNECT */}
                                {activeTab === 'CONNECT' && (
                                    <div className="space-y-6 animate-in fade-in slide-in-from-bottom-2">
                                        <div className="glass p-6 rounded-xl border border-cyan-500/30 text-center">
                                            <h3 className="text-cyan-400 font-bold mb-2">My Identity</h3>
                                            <div className="flex justify-center mb-4"><QRDisplay data={myPublicString} label="My Public Key" /></div>
                                            <p className="text-xs text-slate-400">Scan this on Partner's device</p>
                                        </div>
                                        <div className="text-center text-slate-600">â¬‡ï¸ OR â¬‡ï¸</div>
                                        <button onClick={()=>setScannerMode('KEY')} className="w-full bg-slate-700 hover:bg-slate-600 py-4 rounded-xl font-bold text-white flex items-center justify-center gap-2 border border-slate-600">
                                            <Icon p={icons.cam}/> Scan Partner
                                        </button>
                                    </div>
                                )}

                                {/* TAB 2: VERIFY */}
                                {activeTab === 'VERIFY' && (
                                    <div className="space-y-6 animate-in fade-in slide-in-from-bottom-2">
                                        <div className="glass p-6 rounded-xl border border-yellow-500 text-center">
                                            <h3 className="text-yellow-400 font-bold mb-4 uppercase tracking-widest">Fingerprint Check</h3>
                                            <p className="text-sm text-slate-300 mb-4">Compare these emojis with your partner.</p>
                                            {sharedSecretKey ? (
                                                <div className="bg-slate-900 p-6 rounded-xl border-2 border-yellow-500/50 inline-block mb-4">
                                                    <div className="fingerprint-box text-4xl">{sharedFingerprint}</div>
                                                </div>
                                            ) : <div className="text-red-400 font-bold py-4">Not Connected</div>}
                                            <div className="mt-4 pt-4 border-t border-slate-700">
                                                <p className="text-xs text-slate-400 mb-2">Partner needs to scan you?</p>
                                                <div className="flex justify-center"><QRDisplay data={myPublicString} label="My Identity" /></div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* TAB 3: CHAT */}
                                {activeTab === 'CHAT' && (
                                    <div className="space-y-6 animate-in fade-in slide-in-from-bottom-2">
                                        <div className="glass h-64 rounded-xl flex flex-col overflow-hidden border border-slate-700">
                                            <div className="bg-slate-900/50 p-2 text-xs text-center border-b border-slate-700 text-slate-400">Encrypted Channel: AES-256</div>
                                            <div className="flex-1 overflow-y-auto p-4 space-y-2">
                                                {chatLog.length === 0 && <div className="text-center text-slate-600 text-sm mt-10">No messages yet.</div>}
                                                {chatLog.map((msg, i) => (
                                                    <div key={i} className={`p-2 rounded max-w-[80%] text-sm ${msg.sender === 'Me' ? 'bg-cyan-900/50 ml-auto border border-cyan-500/30 text-white' : 'bg-slate-800 mr-auto border border-slate-600 text-slate-200'}`}>
                                                        <strong>{msg.sender}:</strong> {msg.text}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="flex gap-2">
                                            <input type="text" value={message} onChange={(e) => setMessage(e.target.value)} placeholder="Secret Message..." className="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-4 outline-none focus:border-cyan-500 text-white"/>
                                            <button onClick={encryptMessage} disabled={!sharedSecretKey} className="bg-cyan-600 hover:bg-cyan-500 disabled:opacity-50 px-4 rounded-lg text-white"><Icon p={icons.send}/></button>
                                        </div>
                                        {packetDisplay && (
                                            <div className="glass p-4 rounded-xl text-center">
                                                <p className="text-xs text-slate-400 mb-2">Encrypted Packet</p>
                                                <div className="flex justify-center"><QRDisplay data={packetDisplay} label="Scan on Partner" /></div>
                                            </div>
                                        )}
                                        <button onClick={()=>setScannerMode('MESSAGE')} className="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-lg font-bold text-white flex items-center justify-center gap-2"><Icon p={icons.cam}/> Scan Incoming</button>
                                    </div>
                                )}
                            </main>
                        </>
                    )}

                    {scannerMode && <QRScanner onScan={onScan} onClose={()=>setScannerMode(null)} />}
                    {hackTarget && <HackingTerminal targetType={hackTarget} onClose={()=>setHackTarget(null)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
