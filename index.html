<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crypton</title>
   
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
   
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap');
       
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            overscroll-behavior-y: none;
            height: 100dvh;
            width: 100%;
            overflow: hidden;
        }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        #root {
            height: 100dvh;
            width: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .matrix-bg {
            background-color: #020617;
            background-image:
                radial-gradient(circle at 50% 0%, #1e293b 0%, transparent 70%),
                radial-gradient(#1e293b 1px, transparent 1px);
            background-size: 100% 100%, 30px 30px;
        }
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .nav-pill {
            background: rgba(2, 6, 23, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.6);
        }
        .darth-mode .nav-pill {
            background: rgba(20, 0, 0, 0.95);
            border-color: rgba(239, 68, 68, 0.4);
            box-shadow: 0 10px 40px -10px rgba(220, 38, 38, 0.3);
        }
        .scan-line {
            width: 100%; height: 2px; background: #06b6d4; position: absolute;
            animation: scan 2s linear infinite; box-shadow: 0 0 15px #06b6d4;
        }
        .darth-scan-line { background: #ef4444 !important; box-shadow: 0 0 20px #ef4444 !important; }
        @keyframes scan { 0% { top: 0%; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        .anim-enter { animation: enterUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        .anim-pop { animation: popIn 0.35s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes enterUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.85); } to { opacity: 1; transform: scale(1); } }
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%;
            background: currentColor; cursor: pointer; margin-top: -7px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            height: 5px; background: rgba(255,255,255,0.12); border-radius: 3px;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .typing-animation {
            overflow: hidden; border-right: .15em solid #06b6d4;
            white-space: nowrap; animation: typing 3.5s steps(40, end), blink-caret .75s step-end infinite;
        }
        .darth-mode .typing-animation { border-right-color: #ef4444; }
        @keyframes typing { from { width: 0 } to { width: 100% } }
        @keyframes blink-caret { from, to { border-color: transparent } 50% { border-color: currentColor; } }
    </style>
</head>
<body class="matrix-bg selection:bg-cyan-500 selection:text-white">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const PROTOCOL = { VERSION: '2.4', QR_CHUNK_SIZE: 350, DEFAULT_QR_FPS: 200 };

        const Icon = ({ p, size=24, className="" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{p}</svg>
        );

        const icons = {
            shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />,
            skull: <><path d="M12 2c-4 0-8 3-8 8 0 1.5.5 3 1.5 4C4 16 3 22 3 22h18s-1-6-2.5-8c1-1 1.5-2.5 1.5-4 0-5-4-8-8-8z"/><circle cx="9" cy="10" r="1.5"/><circle cx="15" cy="10" r="1.5"/><path d="M9 14h6"/></>,
            lock: <><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>,
            unlock: <><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></>,
            send: <><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>,
            x: <><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>,
            bug: <><rect x="8" y="6" width="8" height="12" rx="4"/><path d="M12 12v.01"/><path d="M4 14h4"/><path d="M16 14h4"/><path d="M4 10h4"/><path d="M16 10h4"/><path d="M4 18h4"/><path d="M16 18h4"/></>,
            connect: <><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></>,
            message: <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />,
            qr: <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />,
            scan: <><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/></>,
            file: <><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></>,
            // FIXED & MENACING DARTH EYE
            eye: <>
                <circle cx="12" cy="12" r="10.5" fill="none" stroke="#ef4444" strokeWidth="2.5"/>
                <circle cx="12" cy="12" r="7" fill="#7f1d1d"/>
                <circle cx="12" cy="12" r="4" fill="#ef4444"/>
                <circle cx="12" cy="12" r="2" fill="#000"/>
                <g stroke="#ef4444" strokeWidth="2" strokeLinecap="round">
                    <line x1="2" y1="12" x2="6" y2="12"/>
                    <line x1="18" y1="12" x2="22" y2="12"/>
                    <line x1="12" y1="2" x2="12" y2="6"/>
                    <line x1="12" y1="18" x2="12" y2="22"/>
                    <line x1="5" y1="5" x2="8" y2="8"/>
                    <line x1="16" y1="16" x2="19" y2="19"/>
                    <line x1="5" y1="19" x2="8" y2="16"/>
                    <line x1="16" y1="8" x2="19" y2="5"/>
                </g>
            </>,
        };

        // Crypto utils (unchanged)
        const buf2hex = buf => [...new Uint8Array(buf)].map(x => x.toString(16).padStart(2,'0')).join('');
        const hex2buf = hex => new Uint8Array(hex.match(/.{1,2}/g).map(b=>parseInt(b,16))).buffer;
        const generateFingerprint = async buffer => {
            const hash = await crypto.subtle.digest('SHA-256', buffer);
            const arr = new Uint8Array(hash);
            const emojis = ["skull","ghost","demon","imp","rage","exploding_head","radioactive","biohazard","syringe","pill","dagger","bomb","crossed_swords","alien","robot","zombie","vampire","bat","spider","scorpion","snake","dragon"];
            let em = ""; for(let i=0;i<4;i++) em += emojis[arr[i]%emojis.length];
            return { emoji: em, hex: buf2hex(hash).substring(0,8).toUpperCase() };
        };

        // Components (unchanged except minor theme tweaks)
        const QRDisplay = ({ data, label, subLabel }) => {
            const ref = useRef(null);
            useEffect(() => { if(ref.current && data) new QRious({element:ref.current,value:data,size:256,level:'L'}); }, [data]);
            return (
                <div className="bg-white p-4 rounded-2xl shadow-2xl anim-pop">
                    <canvas ref={ref} className="border-4 border-white rounded-lg"/>
                    {label && <div className="mt-3 text-center"><p className="text-black font-bold text-sm">{label}</p>
                        {subLabel && <p className="text-slate-500 text-[10px] font-mono uppercase">{subLabel}</p>}</div>}
                </div>
            );
        };

        const AnimatedQR = ({ chunks, label, onClose, theme="cyan" }) => {
            const [i, setI] = useState(0);
            const [speed, setSpeed] = useState(PROTOCOL.DEFAULT_QR_FPS);
            const [paused, setPaused] = useState(false);
            const multi = chunks.length > 1;
            useEffect(() => { if(!paused && multi) { const id = setInterval(()=>setI(p=>(p+1)%chunks.length), speed); return ()=>clearInterval(id); } }, [paused, speed, multi, chunks]);
            const color = theme==="red" ? "red" : "cyan";
            return (
                <div className="fixed inset-0 z-[100] bg-black/95 flex flex-col items-center justify-center p-6 anim-enter">
                    <div className="relative w-full max-w-sm">
                        <QRDisplay data={chunks[i]} label={label} subLabel={multi?`Part ${i+1}/${chunks.length}`:''}/>
                        {multi && (
                            <div className="mt-6 bg-white/5 p-5 rounded-2xl border border-white/10 space-y-5">
                                <input type="range" min="0" max={chunks.length-1} value={i} onChange={e=> {setI(+e.target.value); setPaused(true);}} className={`w-full accent-${color}-500`}/>
                                <input type="range" min="50" max="1000" step="50" value={speed} onChange={e=>setSpeed(+e.target.value)} className={`w-full accent-${color}-500`}/>
                                <div className="flex justify-center gap-8">
                                    <button onClick={()=>setI(p=>(p-1+chunks.length)%chunks.length)} className="p-3 bg-slate-800 rounded-full"><Icon p={icons.send} className="rotate-180 scale-75"/></button>
                                    <button onClick={()=>setPaused(!paused)} className={`p-5 rounded-full ${theme==="red"?"bg-red-600":"bg-cyan-600"} text-white shadow-2xl active:scale-95`}><Icon p={icons.send} className={paused?"":"rotate-12"}/></button>
                                    <button onClick={()=>setI(p=>(p+1)%chunks.length)} className="p-3 bg-slate-800 rounded-full"><Icon p={icons.send} className="scale-75"/></button>
                                </div>
                            </div>
                        )}
                        <button onClick={onClose} className="mt-10 w-14 h-14 rounded-full bg-white/10 flex items-center justify-center text-white/60 hover:bg-white/20 transition"><Icon p={icons.x}/></button>
                    </div>
                </div>
            );
        };

        const QRScanner = ({ onScan, onClose, isDarth }) => {
            const video = useRef(null), canvas = useRef(null);
            const [err, setErr] = useState(null);
            useEffect(() => {
                let stream, frame;
                navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(s=>{
                    stream=s; video.current.srcObject=s; video.current.play(); frame=requestAnimationFrame(tick);
                }).catch(()=>setErr("Camera denied"));
                const tick = () => {
                    if(video.current?.readyState===4){
                        const ctx = canvas.current.getContext("2d",{willReadFrequently:true});
                        ctx.drawImage(video.current,0,0,canvas.current.width=video.current.videoWidth,canvas.current.height=video.current.videoHeight);
                        const code = jsQR(ctx.getImageData(0,0,canvas.current.width,canvas.current.height).data, canvas.current.width, canvas.current.height);
                        if(code) onScan(code.data);
                    }
                    frame=requestAnimationFrame(tick);
                };
                return () => { stream?.getTracks().forEach(t=>t.stop()); cancelAnimationFrame(frame); };
            },[]);
            return (
                <div className="fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center p-4 anim-enter">
                    {err?<div className="text-red-500 bg-slate-900 p-8 rounded-2xl"><p className="font-bold mb-4">{err}</p><button onClick={onClose} className="bg-slate-800 px-6 py-3 rounded-full">Close</button></div>:(
                        <div className={`relative w-full max-w-sm aspect-square rounded-[2.5rem] overflow-hidden border-6 ${isDarth?'border-red-600 shadow-red-900/60':'border-cyan-500 shadow-cyan-900/60'} shadow-2xl`}>
                            <video ref={video} className="absolute inset-0 w-full h-full object-cover" playsInline muted/>
                            <canvas ref={canvas} className="hidden"/>
                            <div className={`scan-line ${isDarth?'darth-scan-line':''}`}/>
                            <div className="absolute inset-0 border-[40px] border-black/40 rounded-[2.5rem] pointer-events-none"/>
                            <div className="absolute top-8 left-8 w-12 h-12 border-t-6 border-l-6 border-white/80 rounded-tl-3xl"/>
                            <div className="absolute top-8 right-8 w-12 h-12 border-t-6 border-r-6 border-white/80 rounded-tr-3xl"/>
                            <div className="absolute bottom-8 left-8 w-12 h-12 border-b-6 border-l-6 border-white/80 rounded-bl-3xl"/>
                            <div className="absolute bottom-8 right-8 w-12 h-12 border-b-6 border-r-6 border-white/80 rounded-br-3xl"/>
                        </div>
                    )}
                    <button onClick={onClose} className="mt-10 px-8 py-4 bg-white/10 backdrop-blur rounded-full text-white font-bold flex items-center gap-3 hover:bg-white/20 transition"><Icon p={icons.x} size={22}/> Cancel</button>
                </div>
            );
        };

        const App = () => {
            const [mode, setMode] = useState('NORMAL');
            const [tab, setTab] = useState('CONNECT');
            const [keys, setKeys] = useState(null);
            const [identity, setIdentity] = useState(null);
            const [reply, setReply] = useState(null);
            const [sessionKey, setSessionKey] = useState(null);
            const [fp, setFp] = useState(null);
            const [scanner, setScanner] = useState(null);
            const [chat, setChat] = useState([]);
            const [msg, setMsg] = useState("");
            const [transfer, setTransfer] = useState(null);
            const [intercepted, setIntercepted] = useState(null);
            const [showPill, setShowPill] = useState(true);
            const lastScan = useRef("");
            const chatEnd = useRef(null);
            const lastY = useRef(0);

            useEffect(()=>{ chatEnd.current?.scrollIntoView({behavior:"smooth"}); },[chat]);

            const genKeys = async () => {
                const rsa = await crypto.subtle.generateKey({name:"RSA-OAEP",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:"SHA-256"},true,["encrypt","decrypt"]);
                const ecdh = await crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},true,["deriveKey"]);
                const exp = await crypto.subtle.exportKey("spki",rsa.publicKey);
                const fp = await generateFingerprint(exp);
                setKeys({rsa,ecdh});
                setIdentity({t:"ID",k:btoa(String.fromCharCode(...new Uint8Array(exp))),fp:fp.hex});
            };
            useEffect(()=>{genKeys();},[]);

            const handleScan = async raw => {
                if(raw===lastScan.current) return;
                lastScan.current = raw;
                if(mode==='DARTH'){ setIntercepted({raw,time:new Date().toLocaleTimeString()}); setScanner(null); return; }
                try {
                    const p = JSON.parse(raw);
                    if(p.t==="ID"){
                        const pub = await crypto.subtle.importKey("spki",Uint8Array.from(atob(p.k),c=>c.charCodeAt(0)),{name:"RSA-OAEP",hash:"SHA-256"},true,["encrypt"]);
                        const my = await crypto.subtle.exportKey("raw",keys.ecdh.publicKey);
                        const enc = await crypto.subtle.encrypt({name:"RSA-OAEP"},pub,my);
                        setReply(JSON.stringify({t:"HSH",d:buf2hex(enc)}));
                        setScanner(null);
                        alert(`Partner fingerprint: ${p.fp}\nVerify it matches!`);
                    } else if(p.t==="HSH"){
                        const dec = await crypto.subtle.decrypt({name:"RSA-OAEP"},keys.rsa.privateKey,hex2buf(p.d));
                        const partner = await crypto.subtle.importKey("raw",dec,{name:"ECDH",namedCurve:"P-256"},true,[]);
                        const bits = await crypto.subtle.deriveBits({name:"ECDH",public:partner},keys.ecdh.privateKey,256);
                        const sk = await crypto.subtle.deriveKey({name:"HKDF",hash:"SHA-256",salt:new Uint8Array(),info:new TextEncoder().encode("GibberLinkv2_Session")},await crypto.subtle.importKey("raw",bits,{name:"HKDF"},false,["deriveKey"]),{name:"AES-GCM",length:256},false,["encrypt","decrypt"]);
                        const f = await generateFingerprint(bits);
                        setSessionKey(sk); setFp(f); setScanner(null); setTab('VERIFY');
                        alert("Secure tunnel established!");
                    } else if(p.iv && sessionKey){
                        const dec = await crypto.subtle.decrypt({name:"AES-GCM",iv:hex2buf(p.iv)},sessionKey,hex2buf(p.d));
                        setChat(c=>[...c,{from:'Partner',text:new TextDecoder().decode(dec)}]);
                        setScanner(null); setTab('CHAT');
                    }
                } catch(e){ alert("Invalid QR or decryption failed"); }
            };

            const send = async () => {
                if(!msg || !sessionKey) return;
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const enc = await crypto.subtle.encrypt({name:"AES-GCM",iv},sessionKey,new TextEncoder().encode(msg));
                const packet = JSON.stringify({iv:buf2hex(iv),d:buf2hex(enc)});
                const chunks = packet.length>PROTOCOL.QR_CHUNK_SIZE ? packet.match(new RegExp(`.{1,${PROTOCOL.QR_CHUNK_SIZE}}`,'g')) : [packet];
                setTransfer({chunks,label:"Encrypted Message"});
                setChat(c=>[...c,{from:'Me',text:msg,isTyping:true}]);
                setMsg("");
                setTimeout(()=>setChat(c=>c.map(m=>m.isTyping?{...m,isTyping:false}:m)),800);
            };

            const tamper = () => {
                if(!intercepted) return;
                let bad = intercepted.raw;
                try { const p=JSON.parse(bad); if(p.d) p.d=p.d.replace(/^../,"FF"); bad=JSON.stringify(p); } catch{}
                setTransfer({chunks:[bad],label:"TAMPERED PACKET",theme:"red"});
            };

            const toggle = () => { setMode(m=>m==='NORMAL'?'DARTH':'NORMAL'); setScanner(null); setIntercepted(null); };

            return (
                <div className={`h-full flex flex-col relative transition-all duration-700 ${mode==='DARTH'?'darth-mode':''}`}>
                    <header className="fixed top-0 w-full px-6 py-5 flex justify-between items-center z-20 backdrop-blur-xl bg-slate-950/40 border-b border-white/10">
                        <div className="flex items-center gap-4">
                            <div className={`p-3 rounded-2xl ${mode==='DARTH'?'bg-red-900/60':'bg-cyan-900/60'} shadow-2xl`}>
                                <Icon p={mode==='DARTH'?icons.skull:icons.shield} size={26}/>
                            </div>
                            <div>
                                <h1 className="text-xl font-black tracking-tight">Crypton</h1>
                                <p className={`text-[9px] font-bold tracking-widest ${mode==='DARTH'?'text-red-400':'text-cyan-400'}`}>
                                    {mode==='DARTH'?'INTERCEPTOR ACTIVE':'SECURE v2.4'}
                                </p>
                            </div>
                        </div>
                        <button onClick={toggle} className={`p-3 rounded-full border-2 ${mode==='DARTH'?'border-red-600 text-red-400':'border-cyan-600 text-cyan-400'} hover:bg-white/10 transition`}>
                            <Icon p={icons.bug} size={20}/>
                        </button>
                    </header>

                    <main className="flex-1 overflow-y-auto pt-32 pb-20 px-5" onScroll={e=>{const y=e.target.scrollTop; setShowPill(y<20||y<lastY.current); lastY.current=y;}}>
                        <div className="max-w-2xl mx-auto">

                            {/* Normal ModeFlow */}
                            {mode==='NORMAL' && tab==='CONNECT' && identity && (
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                                    <div className="glass-panel p-8 rounded-3xl text-center space-y-6">
                                        <span className="inline-block px-4 py-1 bg-cyan-900/50 rounded-full text-xs font-bold text-cyan-300">STEP 1 – IDENTITY</span>
                                        <QRDisplay data={JSON.stringify(identity)} label="MY PUBLIC KEY" subLabel={identity.fp}/>
                                    </div>
                                    {reply && <div className="glass-panel p-8 rounded-3xl bg-emerald-900/30 border border-emerald-700/50 text-center space-y-6">
                                        <span className="inline-block px-4 py-1 bg-emerald-600/40 rounded-full text-xs font-bold text-emerald-300">STEP 2 – HANDSHAKE</span>
                                        <QRDisplay data={reply} label="SHOW TO PARTNER"/>
                                    </div>}
                                </div>
                            )}

                            {mode==='NORMAL' && tab==='VERIFY' && (
                                <div className="flex flex-col items-center justify-center h-full py-20">
                                    <div className="glass-panel p-10 rounded-3xl text-center max-w-md space-y-8">
                                        <div className={`w-28 h-28 mx-auto rounded-full flex items-center justify-center text-5xl ${sessionKey?'bg-emerald-500 text-black':'bg-slate-800 text-slate-600'}`}>
                                            <Icon p={sessionKey?icons.lock:icons.unlock} size={56}/>
                                        </div>
                                        {sessionKey && fp && (
                                            <div className="bg-black/50 p-8 rounded-3xl border border-emerald-500/30 space-y-6">
                                                <p className="text-xs uppercase tracking-widest text-emerald-400 font-bold">Safety Fingerprint</p>
                                                <div className="text-6xl">{fp.emoji}</div>
                                                <code className="text-2xl font-mono text-yellow-400 tracking-wider">{fp.hex}</code>
                                                <p className="text-xs text-slate-400">Match with partner → No MITM</p>
                                            </div>
                                        )}
                                        {sessionKey && <button onClick={()=>setTab('CHAT')} className="w-full py-5 bg-gradient-to-r from-emerald-500 to-cyan-500 text-black font-bold text-lg rounded-2xl shadow-2xl hover:scale-105 transition">Enter Secure Chat</button>}
                                    </div>
                                </div>
                            )}

                            {mode==='NORMAL' && tab==='CHAT' && (
                                <div className="h-full flex flex-col max-w-2xl mx-auto">
                                    <div className="flex-1 overflow-y-auto space-y-4 pb-32">
                                        {chat.map((m,i)=>
                                            <div key={i} className={`flex ${m.from==='Me'?'justify-end':'justify-start'} anim-pop`}>
                                                <div className={`max-w-xs px-5 py-3 rounded-3xl ${m.from==='Me'?'bg-cyan-600 text-white rounded-br-none':'glass-panel text-slate-200 rounded-bl-none'}`}>
                                                    {m.isTyping?<span className="typing-animation">Encrypting...</span>:m.text}
                                                </div>
                                            </div>
                                        )}
                                        <div ref={chatEnd}/>
                                    </div>
                                    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[95%] max-w-2xl glass-panel rounded-full p-3 flex items-center gap-3 backdrop-blur-xl border border-white/10">
                                        <button onClick={()=>setScanner('QR')} className="p-3 rounded-full bg-slate-800 hover:bg-slate-700 transition"><Icon p={icons.qr} size={22}/></button>
                                        <input value={msg} onChange={e=>setMsg(e.target.value)} onKeyPress={e=>e.key==='Enter'&&send()} placeholder="Secure message..." className="flex-1 bg-transparent outline-none text-white placeholder-slate-500"/>
                                        <button onClick={send} disabled={!msg} className="p-3 rounded-full bg-cyan-500 text-black disabled:opacity-40 shadow-lg hover:bg-cyan-400 transition"><Icon p={icons.send} size={22}/></button>
                                    </div>
                                </div>
                            )}

                            {/* DARTH MODE */}
                            {mode==='DARTH' && (
                                <div className="flex flex-col items-center justify-center h-full space-y-10 py-20">
                                    <div className="glass-panel p-10 rounded-3xl bg-red-950/60 border border-red-800/60 text-center space-y-8 max-w-md">
                                        <div className="text-9xl"><Icon p={icons.eye} size={140}/></div>
                                        <h2 className="text-3xl font-black text-red-400">INTERCEPTOR</h2>
                                        {!intercepted ? (
                                            <button onClick={()=>setScanner('QR')} className="w-full py-16 border-4 border-dashed border-red-800/60 rounded-3xl text-red-500 hover:bg-red-950/40 hover:border-red-600 transition text-2xl font-bold tracking-widest">
                                                TAP TO SNIFF
                                            </button>
                                        ) : (
                                            <div className="space-y-6">
                                                <pre className="text-xs bg-black/60 p-5 rounded-2xl border-l-4 border-red-600 text-red-300 overflow-x-auto font-mono">{intercepted.raw}</pre>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <button onClick={()=>alert("Brute force failed — entropy too high")} className="py-4 bg-red-900/40 border border-red-800 rounded-2xl text-red-300 font-bold">BRUTE FORCE</button>
                                                    <button onClick={tamper} className="py-4 bg-red-600 text-white font-bold rounded-2xl shadow-lg shadow-red-900/50">TAMPER & REPLAY</button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                    <p className="text-center text-xs text-red-500/40 max-w-sm">Tampered packets will fail AES-GCM authentication on the receiver.</p>
                                </div>
                            )}
                        </div>
                    </main>

                    {/* Floating Nav Pill */}
                    {mode==='NORMAL' && (
                        <nav className={`fixed top-28 left-1/2 -translate-x-1/2 w-[92%] max-w-md z-50 transition-transform duration-500 ${showPill?'translate-y-0':'-translate-y-48'} nav-pill rounded-full p-3 flex justify-between items-center shadow-2xl`}>
                            <button onClick={()=>setTab('CONNECT')} className={`flex-1 flex flex-col items-center py-3 rounded-full ${tab==='CONNECT'?'text-cyan-400':'text-slate-500'} transition`}><Icon p={icons.connect} size={24} className={tab==='CONNECT'?'drop-shadow-lg':''}/><span className="text-[9px] font-bold mt-1">CONNECT</span></button>
                            <button onClick={()=>setTab('VERIFY')} className={`flex-1 flex flex-col items-center py-3 rounded-full ${tab==='VERIFY'?'text-emerald-400':'text-slate-500'} transition`}><Icon p={icons.shield} size={24}/><span className="text-[9px] font-bold mt-1">VERIFY</span></button>
                            <button onClick={()=>setScanner('QR')} className="mx-2 p-4 rounded-full bg-cyan-500 text-black shadow-2xl hover:scale-110 active:scale-95 transition"><Icon p={icons.scan} size={28}/></button>
                            <button onClick={()=>setTab('CHAT')} className={`flex-1 flex flex-col items-center py-3 rounded-full ${tab==='CHAT'?'text-white':'text-slate-500'} transition`}><Icon p={icons.message} size={24}/><span className="text-[9px] font-bold mt-1">CHAT</span></button>
                            <button onClick={()=>sessionKey&&setTab('FILES')} disabled={!sessionKey} className={`flex-1 flex flex-col items-center py-3 rounded-full ${!sessionKey?'opacity-30':tab==='FILES'?'text-purple-400':'text-slate-500'} transition`}><Icon p={icons.file} size={24}/><span className="text-[9px] font-bold mt-1">FILES</span></button>
                        </nav>
                    )}

                    {scanner && <QRScanner onScan={handleScan} onClose={()=>setScanner(null)} isDarth={mode==='DARTH'}/>}
                    {transfer && <AnimatedQR {...transfer} onClose={()=>setTransfer(null)}/>}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
