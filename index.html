<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GibberLink v3.0 // Neural Link</title>
    
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- QR Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Space+Mono:wght@400;700&display=swap');

        :root {
            --primary: #06b6d4;
            --primary-glow: rgba(6, 182, 212, 0.5);
            --danger: #ef4444;
            --danger-glow: rgba(239, 68, 68, 0.5);
            --bg: #030712;
            --glass: rgba(17, 24, 39, 0.7);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg);
            color: #f8fafc;
            overflow: hidden; /* App-like feel */
            touch-action: manipulation;
        }

        .font-mono { font-family: 'Space Mono', monospace; }

        /* Custom Animations */
        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100vh); }
        }
        .scan-overlay::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, transparent, var(--primary-glow), transparent);
            height: 100px;
            opacity: 0.1;
            animation: scanline 4s linear infinite;
            pointer-events: none;
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(2); opacity: 0; }
        }
        .pulse-effect::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: var(--primary);
            z-index: -1;
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        @keyframes message-in {
            from { opacity: 0; transform: translateY(10px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .msg-anim { animation: message-in 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

        /* Scrollbar Hide */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Glassmorphism Classes */
        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        /* Darth Mode Overrides */
        .mode-darth {
            --primary: #ef4444;
            --primary-glow: rgba(239, 68, 68, 0.6);
        }
        .mode-darth .glass-panel {
            border-color: rgba(239, 68, 68, 0.2);
            background: rgba(20, 0, 0, 0.8);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        // --- CRYPTO ENGINE (Unchanged Logic, optimized implementation) ---
        const PROTOCOL = { VERSION: '3.0', CHUNK_SIZE: 250 }; // Smaller chunks for faster QR animations

        const buf2hex = (buf) => [...new Uint8Array(buf)].map(x => x.toString(16).padStart(2, '0')).join('');
        const hex2buf = (hex) => new Uint8Array(hex.match(/.{1,2}/g).map(byte => parseInt(byte, 16))).buffer;

        const generateFingerprint = async (buffer) => {
            const hash = await window.crypto.subtle.digest('SHA-256', buffer);
            const arr = new Uint8Array(hash);
            const emojis = ["ðŸ”®","ðŸŒ€","âš¡","ðŸ”¥","ðŸ§¬","ðŸ›¡ï¸","ðŸ’Ž","ðŸ§¿","ðŸ—ï¸","ðŸª","ðŸ‰","ðŸ•¸ï¸","ðŸŽ²","ðŸ§©","ðŸš€","ðŸ›¸"];
            return {
                emoji: Array.from({length: 4}, (_, i) => emojis[arr[i] % emojis.length]).join(''),
                hex: buf2hex(hash).substring(0, 8).toUpperCase()
            };
        };

        // --- UI COMPONENTS ---

        // 1. Icon Component (Lucide Wrapper)
        const Icon = ({ name, size = 24, className = "" }) => {
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // 2. Smart QR Component
        const SmartQR = ({ data, label, subLabel, color }) => {
            const canvasRef = useRef(null);
            const [chunks, setChunks] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);

            // Chunking Logic
            useEffect(() => {
                if (!data) return;
                const c = data.length > PROTOCOL.CHUNK_SIZE 
                    ? data.match(new RegExp(`.{1,${PROTOCOL.CHUNK_SIZE}}`, 'g')) 
                    : [data];
                setChunks(c);
                setCurrentIndex(0);
            }, [data]);

            // Animation Loop (Only if multiple chunks)
            useEffect(() => {
                if (chunks.length <= 1) return;
                const interval = setInterval(() => {
                    setCurrentIndex(prev => (prev + 1) % chunks.length);
                }, 250); // Fast 4fps cycle
                return () => clearInterval(interval);
            }, [chunks]);

            // Drawing Logic
            useEffect(() => {
                if (canvasRef.current && chunks[currentIndex]) {
                    new QRious({
                        element: canvasRef.current,
                        value: chunks[currentIndex],
                        size: 300,
                        level: 'L',
                        foreground: color,
                        background: 'white'
                    });
                }
            }, [chunks, currentIndex, color]);

            return (
                <div className="flex flex-col items-center justify-center p-6 bg-white rounded-3xl shadow-[0_0_40px_rgba(0,0,0,0.3)] mx-4 transform transition-all hover:scale-[1.02]">
                    <div className="relative">
                        <canvas ref={canvasRef} className="max-w-full h-auto rounded-lg" />
                        {chunks.length > 1 && (
                            <div className="absolute top-2 right-2 bg-black/80 text-white text-[10px] font-mono px-2 py-1 rounded-full backdrop-blur-md">
                                {currentIndex + 1}/{chunks.length}
                            </div>
                        )}
                    </div>
                    <div className="mt-4 text-center">
                        <h3 className="text-slate-900 font-bold text-lg tracking-tight">{label}</h3>
                        <p className="text-slate-500 text-xs font-mono mt-1">{subLabel}</p>
                    </div>
                </div>
            );
        };

        // 3. Scanner Overlay
        const ScannerOverlay = ({ onScan, onClose, mode }) => {
            const videoRef = useRef(null);
            const [error, setError] = useState(null);

            useEffect(() => {
                let stream;
                let animFrame;
                const startCamera = async () => {
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                        if(videoRef.current) {
                            videoRef.current.srcObject = stream;
                            videoRef.current.play();
                            requestAnimationFrame(tick);
                        }
                    } catch(e) { setError("Camera Access Denied"); }
                };

                const tick = () => {
                    if (videoRef.current && videoRef.current.readyState === 4) {
                        const canvas = document.createElement('canvas');
                        canvas.width = videoRef.current.videoWidth;
                        canvas.height = videoRef.current.videoHeight;
                        const ctx = canvas.getContext('2d', {willReadFrequently: true});
                        ctx.drawImage(videoRef.current, 0, 0);
                        const img = ctx.getImageData(0,0, canvas.width, canvas.height);
                        const code = jsQR(img.data, img.width, img.height);
                        if(code) {
                            // Haptic feedback
                            if (navigator.vibrate) navigator.vibrate(50);
                            onScan(code.data);
                            return; // Stop scanning loop on success (wait for parent to close)
                        }
                    }
                    animFrame = requestAnimationFrame(tick);
                }

                startCamera();
                return () => {
                    if(stream) stream.getTracks().forEach(t => t.stop());
                    cancelAnimationFrame(animFrame);
                };
            }, []);

            return (
                <div className="fixed inset-0 z-50 bg-black flex flex-col items-center justify-center">
                    <div className="absolute inset-0 opacity-20 bg-[url('https://grainy-gradients.vercel.app/noise.svg')]"></div>
                    
                    {error ? (
                        <div className="text-red-500 text-center p-4">
                            <Icon name="alert-triangle" size={48} className="mx-auto mb-4"/>
                            <p>{error}</p>
                            <button onClick={onClose} className="mt-4 px-6 py-2 bg-slate-800 rounded-full">Close</button>
                        </div>
                    ) : (
                        <>
                            <video ref={videoRef} className="absolute inset-0 w-full h-full object-cover opacity-60" playsInline muted />
                            
                            {/* Scanning UI */}
                            <div className="relative w-72 h-72 border-2 border-[var(--primary)] rounded-3xl z-10 overflow-hidden shadow-[0_0_100px_var(--primary-glow)]">
                                <div className="absolute top-0 left-0 w-full h-1 bg-[var(--primary)] animate-[scanline_2s_linear_infinite] shadow-[0_0_15px_var(--primary)]"></div>
                                <div className="absolute inset-0 border-[40px] border-black/50"></div>
                            </div>
                            
                            <div className="z-10 mt-12 text-center">
                                <div className="text-[var(--primary)] font-mono text-xs tracking-[0.3em] uppercase animate-pulse">
                                    {mode === 'DARTH' ? 'Intercepting...' : 'Searching Target...'}
                                </div>
                                <button onClick={onClose} className="mt-8 bg-black/60 backdrop-blur text-white px-6 py-3 rounded-full flex items-center gap-2 border border-white/10 hover:bg-white/10 transition-colors">
                                    <Icon name="x" size={18} /> Cancel
                                </button>
                            </div>
                        </>
                    )}
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [mode, setMode] = useState('NORMAL'); // NORMAL | DARTH
            const [view, setView] = useState('HOME'); // HOME | CHAT | SETTINGS
            
            // Crypto State
            const [keys, setKeys] = useState(null);
            const [identity, setIdentity] = useState(null); // { t: 'ID', k: '...', fp: '...' }
            const [session, setSession] = useState(null); // { key: CryptoKey, fp: '...' }
            
            // Interaction State
            const [showScanner, setShowScanner] = useState(false);
            const [qrPayload, setQrPayload] = useState(null); // Data to show in QR modal
            const [chat, setChat] = useState([]);
            const [inputMsg, setInputMsg] = useState("");
            const [isListening, setIsListening] = useState(false);
            
            // Darth State
            const [intercepted, setIntercepted] = useState(null);

            const chatEndRef = useRef(null);

            // 1. Initialization
            useEffect(() => {
                lucide.createIcons();
                initKeys();
            }, []);

            useEffect(() => {
                lucide.createIcons();
                if(chatEndRef.current) chatEndRef.current.scrollIntoView({ behavior: 'smooth' });
            }, [chat, view, mode, showScanner, qrPayload]); // Re-run icons on render updates

            const initKeys = async () => {
                const rsa = await window.crypto.subtle.generateKey(
                    { name: "RSA-OAEP", modulusLength: 2048, publicExponent: new Uint8Array([1, 0, 1]), hash: "SHA-256" },
                    true, ["encrypt", "decrypt"]
                );
                const ecdh = await window.crypto.subtle.generateKey(
                    { name: "ECDH", namedCurve: "P-256" },
                    true, ["deriveKey", "deriveBits"]
                );
                const rsaExp = await window.crypto.subtle.exportKey("spki", rsa.publicKey);
                const fp = await generateFingerprint(rsaExp);
                
                setKeys({ rsa, ecdh });
                setIdentity({
                    t: 'ID',
                    k: btoa(String.fromCharCode(...new Uint8Array(rsaExp))),
                    fp: fp.hex,
                    emoji: fp.emoji
                });
            };

            // 2. Handshake Logic
            const processScan = async (raw) => {
                try {
                    // DARTH MODE INTERCEPTION
                    if (mode === 'DARTH') {
                        setIntercepted({ 
                            raw, 
                            time: new Date().toLocaleTimeString(),
                            id: Math.random().toString(36).substr(2,6).toUpperCase()
                        });
                        setShowScanner(false);
                        return;
                    }

                    // NORMAL MODE
                    const data = JSON.parse(raw);
                    
                    if (data.t === 'ID') {
                        // Received Public Identity -> Generate Session Key
                        const partnerRsa = await window.crypto.subtle.importKey(
                            "spki", 
                            Uint8Array.from(atob(data.k), c => c.charCodeAt(0)), 
                            { name: "RSA-OAEP", hash: "SHA-256" }, 
                            true, ["encrypt"]
                        );
                        
                        // Encrypt my ECDH public key with their RSA
                        const myEcdhRaw = await window.crypto.subtle.exportKey("raw", keys.ecdh.publicKey);
                        const encEcdh = await window.crypto.subtle.encrypt({ name: "RSA-OAEP" }, partnerRsa, myEcdhRaw);
                        
                        // Show Response QR
                        setQrPayload({
                            data: JSON.stringify({ t: 'HSH', d: buf2hex(encEcdh) }),
                            label: "HANDSHAKE RESPONSE",
                            subLabel: "Show this to your partner"
                        });
                        setShowScanner(false);
                    } 
                    else if (data.t === 'HSH') {
                        // Received Handshake Response -> Derive Session
                        const encBuf = hex2buf(data.d);
                        const partnerEcdhRaw = await window.crypto.subtle.decrypt({ name: "RSA-OAEP" }, keys.rsa.privateKey, encBuf);
                        
                        const partnerEcdhKey = await window.crypto.subtle.importKey(
                            "raw", partnerEcdhRaw, { name: "ECDH", namedCurve: "P-256" }, true, []
                        );

                        const sharedBits = await window.crypto.subtle.deriveBits(
                            { name: "ECDH", public: partnerEcdhKey }, keys.ecdh.privateKey, 256
                        );

                        const hkdfKey = await window.crypto.subtle.importKey("raw", sharedBits, { name: "HKDF" }, false, ["deriveKey"]);
                        const sessionKey = await window.crypto.subtle.deriveKey(
                            { name: "HKDF", hash: "SHA-256", salt: new Uint8Array(), info: new TextEncoder().encode("GibberLinkv3") },
                            hkdfKey,
                            { name: "AES-GCM", length: 256 },
                            false, ["encrypt", "decrypt"]
                        );

                        const fp = await generateFingerprint(sharedBits);
                        setSession({ key: sessionKey, fp });
                        setShowScanner(false);
                        setView('CHAT');
                        setChat([{ from: 'sys', text: `Secure Tunnel Established.\nFingerprint: ${fp.emoji} ${fp.hex}` }]);
                    }
                    else if (data.iv) {
                        // Received Message
                        if (!session) throw new Error("No session");
                        const pt = await window.crypto.subtle.decrypt(
                            { name: "AES-GCM", iv: hex2buf(data.iv) }, session.key, hex2buf(data.d)
                        );
                        const text = new TextDecoder().decode(pt);
                        setChat(prev => [...prev, { from: 'them', text, time: new Date().toLocaleTimeString() }]);
                        setShowScanner(false);
                        setView('CHAT');
                    }
                } catch (e) {
                    alert("Handshake Failed or Invalid Key");
                    console.error(e);
                }
            };

            // 3. Message Logic
            const sendMessage = async () => {
                if (!inputMsg.trim() || !session) return;
                
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const enc = await window.crypto.subtle.encrypt(
                    { name: "AES-GCM", iv }, session.key, new TextEncoder().encode(inputMsg)
                );
                
                const payload = JSON.stringify({ iv: buf2hex(iv), d: buf2hex(enc) });
                setChat(prev => [...prev, { from: 'me', text: inputMsg, time: new Date().toLocaleTimeString() }]);
                setInputMsg("");
                
                setQrPayload({
                    data: payload,
                    label: "ENCRYPTED PACKET",
                    subLabel: "Scan to decrypt"
                });
            };

            // 4. Voice Logic
            const toggleVoice = () => {
                if (!('webkitSpeechRecognition' in window)) {
                    alert("Voice not supported in this browser.");
                    return;
                }
                if (isListening) return;

                const recognition = new window.webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                
                recognition.onstart = () => setIsListening(true);
                recognition.onend = () => setIsListening(false);
                recognition.onresult = (e) => {
                    const transcript = e.results[0][0].transcript;
                    setInputMsg(prev => prev + (prev ? " " : "") + transcript);
                };
                
                recognition.start();
            };

            // 5. Render Helpers
            const themeClass = mode === 'DARTH' ? 'mode-darth' : '';

            return (
                <div className={`h-[100dvh] w-full flex flex-col relative ${themeClass}`}>
                    {/* BACKGROUND ELEMENTS */}
                    <div className="absolute inset-0 z-0 bg-gradient-to-b from-[var(--bg)] to-slate-900 pointer-events-none"></div>
                    <div className="absolute inset-0 z-0 opacity-20 pointer-events-none" 
                         style={{backgroundImage: 'radial-gradient(circle at 50% 50%, var(--primary-glow) 0%, transparent 50%)'}}></div>

                    {/* TOP NAV */}
                    <header className="z-10 px-6 py-4 flex justify-between items-center glass-panel m-4 rounded-2xl mb-2">
                        <div className="flex items-center gap-3">
                            <div className={`w-2 h-2 rounded-full animate-pulse ${mode==='DARTH' ? 'bg-red-500' : 'bg-cyan-500'}`}></div>
                            <h1 className="font-bold tracking-widest text-sm flex flex-col leading-none">
                                GIBBERLINK
                                <span className="text-[10px] font-mono text-slate-400 opacity-70">V3.0 // {mode}</span>
                            </h1>
                        </div>
                        <button onClick={() => setMode(m => m === 'NORMAL' ? 'DARTH' : 'NORMAL')} 
                                className="p-2 rounded-full hover:bg-white/5 transition-colors text-slate-400 hover:text-[var(--primary)]">
                            <Icon name={mode === 'NORMAL' ? 'shield' : 'skull'} size={20} />
                        </button>
                    </header>

                    {/* MAIN CONTENT AREA */}
                    <main className="flex-1 relative z-10 overflow-hidden flex flex-col">
                        
                        {/* VIEW: HOME (CONNECT) */}
                        {view === 'HOME' && (
                            <div className="h-full flex flex-col items-center justify-center p-6 space-y-8 animate-[message-in_0.5s_ease-out]">
                                {/* Identity Card */}
                                <div className="w-full max-w-sm glass-panel p-6 rounded-3xl flex flex-col items-center text-center relative overflow-hidden group">
                                    <div className="absolute top-0 left-0 w-full h-1 bg-[var(--primary)]"></div>
                                    <div className="mb-4 bg-slate-800/50 p-3 rounded-full border border-white/5 text-[var(--primary)] shadow-[0_0_20px_var(--primary-glow)]">
                                        <Icon name="fingerprint" size={32} />
                                    </div>
                                    <h2 className="text-xl font-bold mb-1">My Identity</h2>
                                    <p className="text-slate-500 text-xs font-mono mb-4">{identity?.fp || "Generating..."}</p>
                                    
                                    <button onClick={() => setQrPayload({ data: JSON.stringify(identity), label: "MY IDENTITY", subLabel: "Scan to Connect" })}
                                            className="w-full py-3 bg-[var(--primary)] text-black font-bold rounded-xl hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
                                        <Icon name="qr-code" size={18} /> Show ID
                                    </button>
                                </div>

                                {/* Main Action */}
                                <button onClick={() => setShowScanner(true)} 
                                        className="pulse-effect relative w-24 h-24 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center text-white shadow-2xl active:scale-95 transition-transform z-10">
                                    <Icon name="scan-line" size={32} />
                                </button>
                                <p className="text-xs text-slate-500 font-mono tracking-widest uppercase">Tap to Scan</p>
                            </div>
                        )}

                        {/* VIEW: CHAT */}
                        {view === 'CHAT' && (
                            <div className="flex flex-col h-full">
                                {/* Session Status */}
                                <div className="px-6 py-2 flex items-center justify-center gap-2 text-[10px] font-mono text-[var(--primary)] opacity-80 border-b border-white/5">
                                    <Icon name="lock" size={10} />
                                    ENCRYPTED: AES-GCM-256
                                </div>

                                {/* Messages */}
                                <div className="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar">
                                    {chat.map((c, i) => (
                                        <div key={i} className={`flex ${c.from === 'me' ? 'justify-end' : c.from === 'sys' ? 'justify-center' : 'justify-start'} msg-anim`}>
                                            {c.from === 'sys' ? (
                                                <div className="text-[10px] font-mono text-slate-500 bg-slate-900/50 px-3 py-1 rounded-full border border-white/5">
                                                    {c.text}
                                                </div>
                                            ) : (
                                                <div className={`max-w-[80%] p-4 rounded-2xl relative group ${c.from === 'me' 
                                                    ? 'bg-[var(--primary)] text-black rounded-tr-sm' 
                                                    : 'glass-panel text-slate-200 rounded-tl-sm'}`}>
                                                    <p className="text-sm leading-relaxed">{c.text}</p>
                                                    <span className="text-[9px] opacity-40 absolute bottom-1 right-2">{c.time}</span>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                    <div ref={chatEndRef}></div>
                                </div>

                                {/* Input Area */}
                                <div className="p-4 glass-panel m-2 mb-4 rounded-3xl flex items-center gap-2">
                                    <button onClick={toggleVoice} 
                                            className={`p-3 rounded-full transition-all ${isListening ? 'bg-red-500 text-white animate-pulse' : 'bg-slate-800 text-slate-400'}`}>
                                        <Icon name={isListening ? "mic" : "mic-off"} size={18} />
                                    </button>
                                    
                                    <input value={inputMsg} onChange={(e) => setInputMsg(e.target.value)}
                                           onKeyDown={(e) => e.key === 'Enter' && sendMessage()}
                                           placeholder="Type encrypted message..."
                                           className="flex-1 bg-transparent border-none outline-none text-white placeholder-slate-600 text-sm h-full"
                                    />
                                    
                                    <button onClick={sendMessage} disabled={!inputMsg}
                                            className="p-3 bg-white/10 rounded-full text-[var(--primary)] hover:bg-[var(--primary)] hover:text-black transition-all disabled:opacity-30">
                                        <Icon name="send" size={18} />
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* DARTH MODE OVERLAY */}
                        {mode === 'DARTH' && view === 'HOME' && intercepted && (
                             <div className="absolute inset-4 glass-panel rounded-3xl p-6 flex flex-col border-l-4 border-red-500 animate-[message-in_0.3s_ease-out]">
                                <div className="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 className="text-red-500 font-bold flex items-center gap-2">
                                            <Icon name="radio" size={16} /> PACKET INTERCEPTED
                                        </h3>
                                        <p className="text-[10px] font-mono text-slate-500">ID: {intercepted.id}</p>
                                    </div>
                                    <button onClick={() => setIntercepted(null)} className="text-slate-500 hover:text-white"><Icon name="x" size={16}/></button>
                                </div>
                                
                                <div className="flex-1 bg-black/50 rounded-lg p-2 font-mono text-[9px] text-red-400 overflow-hidden break-all border border-red-900/30 relative mb-4">
                                    <div className="absolute top-0 left-0 w-full h-full bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-10"></div>
                                    {intercepted.raw}
                                </div>

                                <div className="grid grid-cols-2 gap-2">
                                    <button onClick={() => {
                                        const tampered = intercepted.raw.replace(/./, 'X'); // Simple tamper
                                        setQrPayload({ data: tampered, label: "TAMPERED PACKET", subLabel: "GCM Auth Tag Should Fail", color: "red" });
                                    }} className="bg-red-900/40 border border-red-500/50 text-red-200 py-3 rounded-lg text-xs font-bold hover:bg-red-500 hover:text-black transition-colors">
                                        TAMPER
                                    </button>
                                    <button onClick={() => setQrPayload({ data: intercepted.raw, label: "REPLAY ATTACK", subLabel: "Original Packet", color: "red" })} 
                                            className="bg-slate-800 border border-slate-700 text-slate-300 py-3 rounded-lg text-xs font-bold hover:bg-white hover:text-black transition-colors">
                                        REPLAY
                                    </button>
                                </div>
                            </div>
                        )}

                    </main>

                    {/* BOTTOM NAV */}
                    <nav className="glass-panel m-4 mt-0 rounded-2xl flex justify-around p-2 z-20">
                        <button onClick={() => setView('HOME')} className={`p-3 rounded-xl flex flex-col items-center gap-1 transition-all ${view === 'HOME' ? 'text-[var(--primary)] bg-white/5' : 'text-slate-500'}`}>
                            <Icon name="globe" size={20} />
                            <span className="text-[9px] font-bold">CONNECT</span>
                        </button>
                        <button onClick={() => { if(session) setView('CHAT'); else alert("Connect First"); }} className={`p-3 rounded-xl flex flex-col items-center gap-1 transition-all ${view === 'CHAT' ? 'text-[var(--primary)] bg-white/5' : 'text-slate-500'} ${!session ? 'opacity-50' : ''}`}>
                            <Icon name="message-square" size={20} />
                            <span className="text-[9px] font-bold">SECURE CHAT</span>
                        </button>
                    </nav>

                    {/* FULL SCREEN MODALS */}
                    {showScanner && (
                        <ScannerOverlay onScan={processScan} onClose={() => setShowScanner(false)} mode={mode} />
                    )}

                    {qrPayload && (
                        <div className="fixed inset-0 z-50 bg-black/90 backdrop-blur-sm flex items-center justify-center animate-[message-in_0.2s_ease-out]">
                            <div className="w-full max-w-sm">
                                <SmartQR 
                                    data={qrPayload.data} 
                                    label={qrPayload.label} 
                                    subLabel={qrPayload.subLabel} 
                                    color={qrPayload.color || (mode === 'DARTH' ? 'red' : 'black')} 
                                />
                                <button onClick={() => setQrPayload(null)} className="mt-8 mx-auto flex items-center gap-2 text-white/70 hover:text-white transition-colors">
                                    <Icon name="x-circle" size={24} /> Close
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
