<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoVis: Authenticated RSA+AES</title>
    
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- QR Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'JetBrains Mono', monospace; background-color: #020617; color: #e2e8f0; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(148, 163, 184, 0.1); }
        .scan-line {
            width: 100%; height: 2px; background: #22c55e; position: absolute;
            animation: scan 2s linear infinite; box-shadow: 0 0 10px #22c55e;
        }
        @keyframes scan {
            0% { top: 0%; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; }
        }
        .matrix-bg {
            background-image: radial-gradient(#1e293b 1px, transparent 1px); background-size: 20px 20px;
        }
        .fingerprint-box { font-size: 2rem; letter-spacing: 0.5rem; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
    </style>
</head>
<body class="matrix-bg min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const Icon = ({ d, color="currentColor", size=24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                {d}
            </svg>
        );
        const icons = {
            shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>,
            key: <><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/></>,
            lock: <><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>,
            qr: <><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><path d="M3 14h7v7H3z"/></>,
            camera: <><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></>,
            check: <polyline points="20 6 9 17 4 12"/>,
            skull: <path d="M12 22s4-2 4-7V9c0-5-8-5-8 0v6c0 5 4 7 4 7z" /> // Approximate skull
        };

        // --- CRYPTO UTILS ---
        const buf2hex = (buffer) => [...new Uint8Array(buffer)].map(x => x.toString(16).padStart(2, '0')).join('');
        const hex2buf = (hex) => new Uint8Array(hex.match(/.{1,2}/g).map(byte => parseInt(byte, 16))).buffer;

        // Visual Fingerprint Generator (Authenticity Check)
        // Hashes the Public Key and maps it to Emojis
        const generateFingerprint = async (keyString) => {
            const encoder = new TextEncoder();
            const data = encoder.encode(keyString);
            const hashBuffer = await window.crypto.subtle.digest('SHA-256', data);
            const hashArray = new Uint8Array(hashBuffer);
            
            // Map first 4 bytes to emojis
            const emojis = ["ğŸ¶","ğŸ±","ğŸ­","ğŸ¹","ğŸ°","ğŸ¦Š","ğŸ»","ğŸ¼","ğŸ¨","ğŸ¯","ğŸ¦","ğŸ®","ğŸ·","ğŸ¸","ğŸµ","ğŸ”","ğŸ§","ğŸ¦","ğŸ¤","ğŸ¦†","ğŸ¦…","ğŸ¦‰","ğŸ¦‡","ğŸº","ğŸ—","ğŸ´","ğŸ¦„","ğŸ","ğŸ›","ğŸ¦‹","ğŸŒ","ğŸ","ğŸœ","ğŸ•·","ğŸ•¸","ğŸ¢","ğŸ","ğŸ¦","ğŸ¦‚","ğŸ¦€","ğŸ¦‘","ğŸ™","ğŸ¦","ğŸ ","ğŸŸ","ğŸ¡","ğŸ¬","ğŸ¦ˆ","ğŸ³","ğŸ‹","ğŸŠ","ğŸ†","ğŸ…","ğŸƒ","ğŸ‚","ğŸ„","ğŸª","ğŸ«","ğŸ˜","ğŸ¦","ğŸ¦","ğŸ","ğŸ–","ğŸ","ğŸ","ğŸ‘","ğŸ•","ğŸ©","ğŸˆ","ğŸ“","ğŸ¦ƒ","ğŸ•Š","ğŸ‡","ğŸ","ğŸ€","ğŸ¿","ğŸ¾","ğŸ‰","ğŸ²","ğŸŒµ","ğŸ„","ğŸŒ²","ğŸŒ³","ğŸŒ´","ğŸŒ±","ğŸŒ¿","â˜˜","ğŸ€","ğŸ","ğŸ‹","ğŸƒ","ğŸ‚","ğŸ","ğŸ„","ğŸŒ¾","ğŸ’","ğŸŒ·","ğŸŒ¹","ğŸ¥€","ğŸŒ»","ğŸŒ¼","ğŸŒ¸","ğŸŒº"];
            let fp = "";
            for(let i=0; i<4; i++) {
                fp += emojis[hashArray[i] % emojis.length];
            }
            return fp;
        };

        // --- COMPONENTS ---
        const QRDisplay = ({ data, label }) => {
            const canvasRef = useRef(null);
            useEffect(() => {
                if (canvasRef.current && data) {
                    new QRious({ element: canvasRef.current, value: data, size: 200 });
                }
            }, [data]);
            return (
                <div className="bg-white p-3 rounded-xl flex flex-col items-center shadow-[0_0_20px_rgba(34,197,94,0.3)]">
                    <canvas ref={canvasRef} />
                    <p className="text-black text-[10px] font-mono mt-1 text-center max-w-[180px] break-all">{label}</p>
                </div>
            );
        };

        const QRScanner = ({ onScan, onClose }) => {
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const [err, setErr] = useState("");

            useEffect(() => {
                let stream;
                navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                    .then(s => {
                        stream = s;
                        if(videoRef.current) {
                            videoRef.current.srcObject = s;
                            videoRef.current.play();
                            requestAnimationFrame(tick);
                        }
                    })
                    .catch(() => setErr("Camera blocked. Use HTTPS."));

                const tick = () => {
                    if (videoRef.current && videoRef.current.readyState === 4) {
                        const cvs = canvasRef.current;
                        const vid = videoRef.current;
                        cvs.width = vid.videoWidth;
                        cvs.height = vid.videoHeight;
                        const ctx = cvs.getContext("2d");
                        ctx.drawImage(vid, 0, 0);
                        const img = ctx.getImageData(0, 0, cvs.width, cvs.height);
                        const code = jsQR(img.data, img.width, img.height);
                        if (code) { onScan(code.data); return; }
                    }
                    requestAnimationFrame(tick);
                };
                return () => stream?.getTracks().forEach(t => t.stop());
            }, []);

            return (
                <div className="fixed inset-0 z-50 bg-black flex flex-col items-center justify-center p-4">
                    <div className="relative w-full max-w-sm aspect-square bg-slate-900 rounded-lg overflow-hidden border-2 border-emerald-500">
                        <video ref={videoRef} className="absolute inset-0 w-full h-full object-cover" playsInline />
                        <canvas ref={canvasRef} className="hidden" />
                        <div className="scan-line"></div>
                        {err && <div className="absolute inset-0 flex items-center justify-center text-red-500 bg-black/90 p-4 text-center font-bold">{err}</div>}
                    </div>
                    <button onClick={onClose} className="mt-6 bg-slate-700 px-8 py-3 rounded-full text-white font-bold">Cancel</button>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            // Identity
            const [role, setRole] = useState(null); // 'Receiver' (Bob), 'Sender' (Alice), 'Attacker' (Darth)
            
            // RSA Keys (Identity)
            const [myKeys, setMyKeys] = useState(null);
            const [myPublicString, setMyPublicString] = useState("");
            const [myFingerprint, setMyFingerprint] = useState("");

            // Partner Keys (The one we scanned)
            const [scannedKey, setScannedKey] = useState(null); // The raw key string
            const [scannedFingerprint, setScannedFingerprint] = useState(null);
            const [isVerified, setIsVerified] = useState(false);

            // Message State
            const [message, setMessage] = useState("");
            const [encryptedPacket, setEncryptedPacket] = useState(null);
            const [decryptedMessage, setDecryptedMessage] = useState(null);
            const [logs, setLogs] = useState([]);

            const [scannerMode, setScannerMode] = useState(null); // 'KEY', 'PACKET'

            const log = (m) => setLogs(p => [`> ${m}`, ...p]);

            // 1. Generate RSA Identity
            const generateIdentity = async () => {
                log("Generating RSA-2048 Keypair...");
                const keys = await window.crypto.subtle.generateKey(
                    { name: "RSA-OAEP", modulusLength: 2048, publicExponent: new Uint8Array([1, 0, 1]), hash: "SHA-256" },
                    true, ["encrypt", "decrypt"]
                );
                
                // Export Public Key
                const exported = await window.crypto.subtle.exportKey("spki", keys.publicKey);
                const str = btoa(String.fromCharCode(...new Uint8Array(exported)));
                
                // Generate Fingerprint
                const fp = await generateFingerprint(str);

                setMyKeys(keys);
                setMyPublicString(str);
                setMyFingerprint(fp);
                log(`Identity Ready. Fingerprint: ${fp}`);
            };

            // 2. Process Scanned Key (Verification Step)
            const handleScannedKey = async (keyStr) => {
                log("Public Key Scanned.");
                const fp = await generateFingerprint(keyStr);
                setScannedKey(keyStr);
                setScannedFingerprint(fp);
                log(`Calculated Fingerprint: ${fp}`);
                log("WAITING FOR AUTHENTICITY CHECK...");
            };

            // 3. Encrypt (Hybrid RSA + AES)
            const encryptData = async () => {
                if (!scannedKey) return;
                log("Starting Hybrid Encryption...");
                
                try {
                    // Import Partner's RSA Key
                    const binaryDer = Uint8Array.from(atob(scannedKey), c => c.charCodeAt(0));
                    const rsaPubKey = await window.crypto.subtle.importKey(
                        "spki", binaryDer.buffer, { name: "RSA-OAEP", hash: "SHA-256" }, true, ["encrypt"]
                    );

                    // A. Generate AES Session Key
                    const aesKey = await window.crypto.subtle.generateKey({ name: "AES-GCM", length: 256 }, true, ["encrypt"]);
                    
                    // B. Encrypt Message with AES
                    const iv = window.crypto.getRandomValues(new Uint8Array(12));
                    const enc = new TextEncoder();
                    const encryptedContent = await window.crypto.subtle.encrypt(
                        { name: "AES-GCM", iv }, aesKey, enc.encode(message)
                    );

                    // C. Encrypt AES Key with RSA
                    const rawAes = await window.crypto.subtle.exportKey("raw", aesKey);
                    const encryptedAesKey = await window.crypto.subtle.encrypt(
                        { name: "RSA-OAEP" }, rsaPubKey, rawAes
                    );

                    // D. Package it
                    const packet = JSON.stringify({
                        iv: buf2hex(iv),
                        k: buf2hex(encryptedAesKey), // Encrypted AES Key
                        d: buf2hex(encryptedContent) // Encrypted Data
                    });

                    setEncryptedPacket(packet);
                    log("HYBRID PACKET GENERATED.");
                } catch (e) { log("Encrypt Error: " + e.message); }
            };

            // 4. Decrypt
            const decryptPacket = async (packetStr) => {
                log("Packet Received. Decrypting...");
                try {
                    const pkt = JSON.parse(packetStr);
                    
                    if (role === 'Attacker') {
                        setTimeout(() => {
                            setDecryptedMessage("âŒ ACCESS DENIED. RSA Private Key Mismatch.");
                            log("Decryption Failed: You are not the intended recipient.");
                        }, 1000);
                        return;
                    }

                    // A. Decrypt AES Key using RSA Private Key
                    const rawAes = await window.crypto.subtle.decrypt(
                        { name: "RSA-OAEP" }, myKeys.privateKey, hex2buf(pkt.k)
                    );

                    // B. Import AES Key
                    const aesKey = await window.crypto.subtle.importKey("raw", rawAes, "AES-GCM", true, ["decrypt"]);

                    // C. Decrypt Data
                    const dec = await window.crypto.subtle.decrypt(
                        { name: "AES-GCM", iv: hex2buf(pkt.iv) }, aesKey, hex2buf(pkt.d)
                    );

                    setDecryptedMessage(new TextDecoder().decode(dec));
                    log("DECRYPTION SUCCESSFUL.");
                } catch (e) {
                    setDecryptedMessage("âŒ ERROR");
                    log("Decryption failed. " + e.message);
                }
            };

            const onScan = (data) => {
                setScannerMode(null);
                // Simple heuristic to differentiate Key vs Packet
                if (data.includes('"iv":')) decryptPacket(data);
                else handleScannedKey(data);
            };

            // RENDER: ROLE SELECT
            if (!role) return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4 gap-6">
                    <h1 className="text-3xl font-bold text-emerald-400 text-center">RSA+AES Authenticated Transfer</h1>
                    <p className="text-slate-400 text-center max-w-md text-sm">
                        Demonstrates Hybrid Encryption with <strong>Visual Fingerprint Verification</strong> to prevent Man-in-the-Middle attacks.
                    </p>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 w-full max-w-4xl">
                        <button onClick={()=>{setRole('Receiver'); generateIdentity();}} className="glass p-6 rounded-xl border-l-4 border-emerald-500 hover:bg-slate-800 text-left">
                            <h2 className="text-xl font-bold text-white mb-2">I am Bob (Receiver)</h2>
                            <p className="text-xs text-slate-400">Generates RSA Keys. Displays QR to receive file.</p>
                        </button>
                        <button onClick={()=>{setRole('Sender');}} className="glass p-6 rounded-xl border-l-4 border-blue-500 hover:bg-slate-800 text-left">
                            <h2 className="text-xl font-bold text-white mb-2">I am Alice (Sender)</h2>
                            <p className="text-xs text-slate-400">Scans Bob. Verifies Fingerprint. Sends Encrypted File.</p>
                        </button>
                        <button onClick={()=>{setRole('Attacker'); generateIdentity();}} className="glass p-6 rounded-xl border-l-4 border-red-500 hover:bg-slate-800 text-left">
                            <h2 className="text-xl font-bold text-white mb-2">I am Darth (Attacker)</h2>
                            <p className="text-xs text-slate-400">Impersonates Bob with different keys. Tries to intercept.</p>
                        </button>
                    </div>
                </div>
            );

            // RENDER: MAIN UI
            return (
                <div className="max-w-3xl mx-auto p-4 pb-20">
                    <header className="flex justify-between items-center mb-6 pb-4 border-b border-slate-700">
                        <div>
                            <h1 className="text-lg font-bold text-white">Identity: <span className={role==='Attacker'?'text-red-500':'text-emerald-400'}>{role}</span></h1>
                            {myFingerprint && <div className="text-xs text-slate-400">My Fingerprint: <span className="text-lg ml-1">{myFingerprint}</span></div>}
                        </div>
                        <button onClick={()=>window.location.reload()} className="text-xs bg-slate-800 px-3 py-1 rounded hover:bg-slate-700">Reset</button>
                    </header>

                    <div className="space-y-6">

                        {/* SECTION 1: KEY EXCHANGE */}
                        {(role === 'Receiver' || role === 'Attacker') && (
                            <div className="glass p-6 rounded-xl border border-emerald-500/30">
                                <h3 className="font-bold text-emerald-400 mb-4 flex items-center gap-2"><Icon d={icons.key} size={18}/> 1. Share RSA Public Key</h3>
                                <div className="flex flex-col md:flex-row gap-6 items-center">
                                    <QRDisplay data={myPublicString} label="Public Key" />
                                    <div className="flex-1 text-center md:text-left">
                                        <p className="text-sm text-slate-400 mb-2">Show this to the sender.</p>
                                        <div className="bg-slate-800 p-4 rounded-lg border border-slate-600 inline-block">
                                            <p className="text-xs text-slate-500 uppercase mb-1">Authenticity Fingerprint</p>
                                            <div className="fingerprint-box">{myFingerprint}</div>
                                        </div>
                                        {role === 'Attacker' && <p className="text-red-400 text-xs mt-2 animate-pulse">Warning: This fingerprint is different from Bob's!</p>}
                                    </div>
                                </div>
                            </div>
                        )}

                        {role === 'Sender' && !scannedKey && (
                            <div className="glass p-6 rounded-xl border border-blue-500/30">
                                <h3 className="font-bold text-blue-400 mb-4 flex items-center gap-2"><Icon d={icons.camera} size={18}/> 1. Scan Receiver</h3>
                                <p className="text-sm text-slate-400 mb-4">Scan the QR code on the receiver's screen.</p>
                                <button onClick={()=>setScannerMode('KEY')} className="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-lg font-bold text-white">Open Camera</button>
                            </div>
                        )}

                        {/* SECTION 2: AUTHENTICITY CHECK (The "Twist") */}
                        {role === 'Sender' && scannedKey && !isVerified && (
                            <div className="glass p-6 rounded-xl border border-yellow-500 animate-pulse">
                                <h3 className="font-bold text-yellow-400 mb-4 text-xl">âš ï¸ AUTHENTICITY CHECK</h3>
                                <div className="text-center space-y-4">
                                    <p className="text-slate-300">Look at the receiver's screen. Does their fingerprint match this?</p>
                                    <div className="bg-slate-900 p-6 rounded-xl border-2 border-yellow-500 inline-block">
                                        <div className="fingerprint-box">{scannedFingerprint}</div>
                                    </div>
                                    <div className="flex gap-4 justify-center">
                                        <button onClick={()=>setIsVerified(true)} className="bg-emerald-600 hover:bg-emerald-500 px-6 py-2 rounded font-bold">YES - MATCH</button>
                                        <button onClick={()=>{setScannedKey(null); alert("Security Alert: Potential Man-in-the-Middle Attack!");}} className="bg-red-600 hover:bg-red-500 px-6 py-2 rounded font-bold">NO - ATTACK</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* SECTION 3: ENCRYPT & SEND */}
                        {role === 'Sender' && isVerified && (
                            <div className="glass p-6 rounded-xl border border-emerald-500/30">
                                <h3 className="font-bold text-emerald-400 mb-4 flex items-center gap-2"><Icon d={icons.lock} size={18}/> 2. Encrypt & Transfer</h3>
                                {!encryptedPacket ? (
                                    <div className="space-y-4">
                                        <input value={message} onChange={e=>setMessage(e.target.value)} placeholder="Enter Secret Message..." className="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white outline-none focus:border-emerald-500" />
                                        <button onClick={encryptData} className="w-full bg-emerald-600 hover:bg-emerald-500 py-3 rounded-lg font-bold">Encrypt (Hybrid RSA+AES)</button>
                                    </div>
                                ) : (
                                    <div className="text-center space-y-4">
                                        <div className="bg-slate-800 p-2 rounded text-xs text-emerald-300">Hybrid Packet: AES-256 Data + RSA-2048 Key</div>
                                        <div className="flex justify-center"><QRDisplay data={encryptedPacket} label="Scan on Receiver" /></div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* SECTION 4: DECRYPT */}
                        {(role === 'Receiver' || role === 'Attacker') && (
                            <div className="glass p-6 rounded-xl border border-blue-500/30">
                                <h3 className="font-bold text-blue-400 mb-4 flex items-center gap-2"><Icon d={icons.check} size={18}/> 2. Receive Packet</h3>
                                <button onClick={()=>setScannerMode('PACKET')} className="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-lg font-bold mb-4">Scan Incoming Packet</button>
                                {decryptedMessage && (
                                    <div className={`p-4 rounded-lg border-2 ${decryptedMessage.includes('âŒ') ? 'border-red-500 bg-red-900/20' : 'border-emerald-500 bg-emerald-900/20'}`}>
                                        <p className="text-xs uppercase text-slate-400 mb-1">Result:</p>
                                        <p className="text-xl font-bold text-white">{decryptedMessage}</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* LOGS */}
                        <div className="glass p-4 rounded-xl h-40 overflow-y-auto font-mono text-[10px] text-slate-400 bg-black/40">
                            {logs.map((l,i) => <div key={i}>{l}</div>)}
                        </div>
                    </div>

                    {scannerMode && <QRScanner onScan={onScan} onClose={()=>setScannerMode(null)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
