<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoVis: Secure Air-Gap System</title>
    
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- QR Libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        body { font-family: 'JetBrains Mono', monospace; background-color: #0f172a; color: #e2e8f0; }
        .glass { background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(148, 163, 184, 0.1); }
        .scan-line {
            width: 100%; height: 2px; background: #06b6d4; position: absolute;
            animation: scan 2s linear infinite; box-shadow: 0 0 10px #06b6d4;
        }
        @keyframes scan { 0% { top: 0%; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        .matrix-bg {
            background-image: linear-gradient(rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.9)), url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%231e293b' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .fingerprint { font-size: 2.5rem; letter-spacing: 0.5rem; text-shadow: 0 0 15px rgba(255,255,255,0.3); }
        .spectrum-bar { transition: height 0.05s ease; }
    </style>
</head>
<body class="matrix-bg min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONFIGURATION ---
        const PROTOCOL = {
            START_FREQ: 600,
            END_FREQ: 3200,
            BASE_FREQ: 1000,
            STEP_FREQ: 100,  
            CHAR_DURATION: 0.15,
            HEADER_DURATION: 1.0,
            FFT_SIZE: 2048,
            THRESHOLD: 25,
            QR_FRAME_RATE: 150, 
            QR_CHUNK_SIZE: 500  
        };

        // --- ICONS ---
        const Icon = ({ p, size=24, className="" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {p}
            </svg>
        );
        const icons = {
            shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />,
            key: <><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/><circle cx="7.5" cy="15.5" r="5.5"/></>,
            qr: <><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><path d="M10 7h4"/><path d="M7 10v4"/><path d="M14 10h4"/></>,
            cam: <><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></>,
            send: <><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>,
            sound: <><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></>,
            mic: <><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></>,
            skull: <path d="M12 22s4-2 4-7V9c0-5-8-5-8 0v6c0 5 4 7 4 7z"/>,
            refresh: <><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"/><path d="M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></>,
            file: <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />,
            clip: <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48" />,
            import: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>,
            share: <><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></>
        };

        // --- CRYPTO HELPERS ---
        const buf2hex = (buf) => [...new Uint8Array(buf)].map(x => x.toString(16).padStart(2, '0')).join('');
        const hex2buf = (hex) => new Uint8Array(hex.match(/.{1,2}/g).map(byte => parseInt(byte, 16))).buffer;

        const generateFingerprint = async (buffer) => {
            const hash = await window.crypto.subtle.digest('SHA-256', buffer);
            const arr = new Uint8Array(hash);
            const emojis = ["ğŸ¶","ğŸ±","ğŸ­","ğŸ¹","ğŸ°","ğŸ¦Š","ğŸ»","ğŸ¼","ğŸ¨","ğŸ¯","ğŸ¦","ğŸ®","ğŸ·","ğŸ¸","ğŸµ","ğŸ”","ğŸ§","ğŸ¦","ğŸ¤","ğŸ¦†","ğŸ¦…","ğŸ¦‰","ğŸ¦‡","ğŸº","ğŸ—","ğŸ´","ğŸ¦„","ğŸ","ğŸ›","ğŸ¦‹","ğŸŒ","ğŸ","ğŸœ","ğŸ•·","ğŸ•¸","ğŸ¢","ğŸ","ğŸ¦","ğŸ¦‚","ğŸ¦€","ğŸ¦‘","ğŸ™","ğŸ¦","ğŸ ","ğŸŸ","ğŸ¡","ğŸ¬","ğŸ¦ˆ","ğŸ³","ğŸ‹","ğŸŠ","ğŸ†","ğŸ…","ğŸƒ","ğŸ‚","ğŸ„","ğŸª","ğŸ«","ğŸ˜","ğŸ¦","ğŸ¦","ğŸ","ğŸ–","ğŸ","ğŸ","ğŸ‘","ğŸ•","ğŸ©","ğŸˆ","ğŸ“","ğŸ¦ƒ","ğŸ•Š","ğŸ‡","ğŸ","ğŸ€","ğŸ¿","ğŸ¾","ğŸ‰","ğŸ²","ğŸŒµ","ğŸ„","ğŸŒ²","ğŸŒ³","ğŸŒ´"];
            let fp = "";
            for(let i=0; i<4; i++) fp += emojis[arr[i] % emojis.length];
            return fp;
        };

        // --- AUDIO TRANSMITTER ---
        const SonicTransmitter = {
            play: async (textData, loop = false, stopCallbackRef = { current: null }) => {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                
                let hexData = "";
                for (let i = 0; i < textData.length; i++) hexData += textData.charCodeAt(i).toString(16).padStart(2, '0');

                let isPlaying = true;

                const playSequence = () => {
                    if (!isPlaying) { ctx.close(); return; }

                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.type = 'sine';

                    const now = ctx.currentTime;
                    
                    osc.frequency.setValueAtTime(PROTOCOL.START_FREQ, now);
                    gain.gain.setValueAtTime(0.5, now);

                    let startTime = now + PROTOCOL.HEADER_DURATION;
                    for (let i = 0; i < hexData.length; i++) {
                        const nibble = parseInt(hexData[i], 16);
                        const freq = PROTOCOL.BASE_FREQ + (nibble * PROTOCOL.STEP_FREQ);
                        osc.frequency.setValueAtTime(freq, startTime + (i * PROTOCOL.CHAR_DURATION));
                    }

                    const dataEndTime = startTime + (hexData.length * PROTOCOL.CHAR_DURATION);
                    osc.frequency.setValueAtTime(PROTOCOL.END_FREQ, dataEndTime);
                    
                    osc.start(now);
                    osc.stop(dataEndTime + 0.5);

                    osc.onended = () => {
                        if (isPlaying && loop) setTimeout(playSequence, 1000); 
                        else if (!loop) ctx.close();
                    };
                };

                playSequence();

                stopCallbackRef.current = () => { 
                    isPlaying = false; 
                    try { ctx.close(); } catch(e){} 
                };
                
                return stopCallbackRef.current;
            }
        };

        // --- AUDIO RECEIVER ---
        const AudioListener = ({ onData, expectedType = null, autoAckId = null, onClose }) => {
            const [status, setStatus] = useState("Initializing Mic...");
            const [visuals, setVisuals] = useState(new Array(16).fill(0));
            const [recording, setRecording] = useState(false);
            
            const analyzerRef = useRef(null);
            const rafRef = useRef(null);
            const bufferRef = useRef([]); 
            const startTimeRef = useRef(0);
            const stopListeningRef = useRef(false);

            useEffect(() => {
                let audioContext;
                let stream;

                const initAudio = async () => {
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ 
                            audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: false } 
                        });
                        setStatus(expectedType === 'ACK' ? `Listening for ACK: ${autoAckId}...` : "Listening for Data Stream...");
                        
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const source = audioContext.createMediaStreamSource(stream);
                        const analyzer = audioContext.createAnalyser();
                        analyzer.fftSize = PROTOCOL.FFT_SIZE;
                        analyzer.smoothingTimeConstant = 0.5; 
                        source.connect(analyzer);
                        analyzerRef.current = analyzer;

                        const bufferLength = analyzer.frequencyBinCount;
                        const dataArray = new Uint8Array(bufferLength);
                        const binWidth = audioContext.sampleRate / analyzer.fftSize;

                        const getFreqEnergy = (freq) => {
                            const bin = Math.round(freq / binWidth);
                            return (dataArray[bin-1] + dataArray[bin] + dataArray[bin+1]) / 3;
                        };

                        const findDominantNibble = () => {
                            let maxE = 0, bestI = -1;
                            for(let i=0; i<16; i++) {
                                const f = PROTOCOL.BASE_FREQ + (i * PROTOCOL.STEP_FREQ);
                                const e = getFreqEnergy(f);
                                if (e > maxE) { maxE = e; bestI = i; }
                            }
                            if (maxE < (PROTOCOL.THRESHOLD * 1.5)) return -1;
                            return bestI;
                        };

                        const loop = () => {
                            if (stopListeningRef.current) return;
                            analyzer.getByteFrequencyData(dataArray);
                            const now = performance.now();

                            const v = [];
                            for(let i=0; i<16; i++) {
                                const f = PROTOCOL.BASE_FREQ + (i*PROTOCOL.STEP_FREQ);
                                v.push((getFreqEnergy(f)/255)*100);
                            }
                            setVisuals(v);

                            const startE = getFreqEnergy(PROTOCOL.START_FREQ);
                            const endE = getFreqEnergy(PROTOCOL.END_FREQ);

                            if (!startTimeRef.current) {
                                if (startE > (PROTOCOL.THRESHOLD * 3)) {
                                    startTimeRef.current = now;
                                    setRecording(true);
                                    bufferRef.current = [];
                                    setStatus("Receiving Signal... (Keep Quiet)");
                                }
                            } else {
                                if (endE > (PROTOCOL.THRESHOLD * 3) && (now - startTimeRef.current > 1000)) {
                                    setStatus("End Detected. Decoding...");
                                    const success = decodeSignal();
                                    if (success) {
                                        stopListeningRef.current = true;
                                        return;
                                    }
                                    setStatus("Bad CRC. Waiting for next loop...");
                                    setRecording(false);
                                    startTimeRef.current = 0;
                                    return; 
                                }
                                const currentNibble = findDominantNibble();
                                bufferRef.current.push({ t: now, val: currentNibble });
                            }
                            rafRef.current = requestAnimationFrame(loop);
                        };
                        loop();

                    } catch (e) { setStatus("Microphone Error: " + e.message); }
                };

                initAudio();

                return () => {
                    stopListeningRef.current = true;
                    if(stream) stream.getTracks().forEach(t => t.stop());
                    if(audioContext) audioContext.close();
                    cancelAnimationFrame(rafRef.current);
                };
            }, [expectedType, autoAckId]);

            const decodeSignal = () => {
                const rec = bufferRef.current;
                if (rec.length < 10) return false;
                const startT = rec[0].t;
                const dataStartT = startT + (PROTOCOL.HEADER_DURATION * 1000);
                let hex = "";
                let timeCursor = dataStartT;
                const charMs = PROTOCOL.CHAR_DURATION * 1000;

                while (true) {
                    const samples = rec.filter(s => s.t >= timeCursor && s.t < timeCursor + charMs);
                    if (samples.length === 0) break; 
                    const counts = {};
                    samples.forEach(s => { if (s.val !== -1) counts[s.val] = (counts[s.val] || 0) + 1; });
                    let bestVal = -1, maxCount = 0;
                    for (const [val, count] of Object.entries(counts)) {
                        if (count > maxCount) { maxCount = count; bestVal = val; }
                    }
                    if (bestVal !== -1) hex += parseInt(bestVal).toString(16);
                    else hex += "?"; 
                    timeCursor += charMs;
                }

                let str = "";
                for(let i=0; i<hex.length; i+=2) {
                    const h = hex.substr(i, 2);
                    if (h.indexOf('?') === -1) str += String.fromCharCode(parseInt(h, 16));
                }

                try {
                    const first = str.indexOf('{');
                    const last = str.lastIndexOf('}');
                    if (first > -1 && last > first) {
                        const jsonStr = str.substring(first, last+1);
                        const payload = JSON.parse(jsonStr);
                        
                        if (expectedType === 'ACK') {
                            if (payload.t === 'A' && payload.i === autoAckId) {
                                onData(payload); 
                                return true;
                            }
                            return false; 
                        } 
                        else if (payload.t === 'D') {
                            onData(payload); 
                            return true;
                        }
                    } 
                } catch(e) { console.log("Parse fail", e); }
                return false;
            };

            return (
                <div className="fixed inset-0 z-50 bg-black/95 flex flex-col items-center justify-center p-6">
                    <div className="text-center mb-8">
                        <h2 className="text-2xl font-bold text-white mb-2">SonicLink Receiver</h2>
                        <p className={`font-mono ${recording ? 'text-emerald-400 animate-pulse' : 'text-cyan-400'}`}>{status}</p>
                    </div>
                    <div className="flex items-end gap-1 h-32 mb-4 bg-slate-900/50 p-4 rounded-xl border border-slate-700">
                        {visuals.map((v, i) => (
                            <div key={i} className="w-3 bg-cyan-500 rounded-t transition-all duration-75" style={{height: `${v}%`}}></div>
                        ))}
                    </div>
                    {expectedType !== 'ACK' && (
                        <button onClick={onClose} className="mt-8 bg-slate-800 px-8 py-3 rounded-full text-white font-bold hover:bg-slate-700">Cancel</button>
                    )}
                </div>
            );
        };

        // --- COMPONENTS ---
        const QRDisplay = ({ data, label }) => {
            const canvasRef = useRef(null);
            useEffect(() => {
                if (canvasRef.current && data) {
                    new QRious({ element: canvasRef.current, value: data, size: 220, level: 'L' });
                }
            }, [data]);
            return (
                <div className="bg-white p-4 rounded-2xl flex flex-col items-center shadow-xl">
                    <canvas ref={canvasRef} />
                    <p className="text-black font-bold text-sm mt-2">{label}</p>
                </div>
            );
        };

        const AnimatedQR = ({ chunks, label, onClose }) => {
            const [index, setIndex] = useState(0);
            useEffect(() => {
                if (!chunks || chunks.length === 0) return;
                const interval = setInterval(() => {
                    setIndex(prev => (prev + 1) % chunks.length);
                }, PROTOCOL.QR_FRAME_RATE);
                return () => clearInterval(interval);
            }, [chunks]);
            return (
                <div className="fixed inset-0 z-50 bg-black/95 flex flex-col items-center justify-center p-4">
                    <div className="bg-white p-4 rounded-2xl flex flex-col items-center shadow-[0_0_50px_rgba(6,182,212,0.5)]">
                        <QRDisplay data={chunks[index]} label={`${label} (${index + 1}/${chunks.length})`} />
                        <div className="w-full bg-gray-200 h-2 mt-4 rounded-full overflow-hidden">
                            <div className="bg-blue-600 h-full transition-all" style={{width: `${((index+1)/chunks.length)*100}%`}}></div>
                        </div>
                    </div>
                    <p className="text-cyan-400 mt-4 font-mono text-sm animate-pulse text-center">DIRECT STREAMING...<br/>Point Camera to Receive File</p>
                    <button onClick={onClose} className="mt-8 bg-slate-800 px-8 py-3 rounded-full text-white font-bold hover:bg-slate-700">Stop Broadcast</button>
                </div>
            );
        };

        const QRScanner = ({ onScan, onClose, fileProgress }) => {
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const [error, setError] = useState("");
            const lastScanned = useRef(null); 
            const noSignalCount = useRef(0); // For resetting double-scan memory

            useEffect(() => {
                let stream;
                navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                    .then(s => {
                        stream = s;
                        if (videoRef.current) {
                            videoRef.current.srcObject = s;
                            videoRef.current.play();
                            tick(); 
                        }
                    })
                    .catch(() => setError("Camera Access Denied. Ensure HTTPS/Localhost."));

                const tick = () => {
                    if (videoRef.current && videoRef.current.readyState === 4) {
                        const cvs = canvasRef.current;
                        const vid = videoRef.current;
                        if (cvs && vid) {
                            cvs.width = vid.videoWidth;
                            cvs.height = vid.videoHeight;
                            const ctx = cvs.getContext("2d");
                            ctx.drawImage(vid, 0, 0);
                            const img = ctx.getImageData(0, 0, cvs.width, cvs.height);
                            const code = jsQR(img.data, img.width, img.height);
                            if (code) { 
                                noSignalCount.current = 0;
                                if (code.data !== lastScanned.current) {
                                    lastScanned.current = code.data;
                                    onScan(code.data); 
                                }
                            } else {
                                noSignalCount.current++;
                                // If we don't see a QR for 60 frames (~1 sec), allow rescanning the same code
                                if (noSignalCount.current > 60) {
                                    lastScanned.current = null;
                                }
                            }
                        }
                    }
                    requestAnimationFrame(tick);
                };
                return () => stream?.getTracks().forEach(t => t.stop());
            }, []);

            return (
                <div className="fixed inset-0 z-50 bg-black/95 flex flex-col items-center justify-center p-4">
                    <div className="relative w-full max-w-sm aspect-square bg-slate-900 rounded-2xl overflow-hidden border-2 border-cyan-500 shadow-[0_0_30px_rgba(6,182,212,0.3)]">
                        <video ref={videoRef} className="absolute inset-0 w-full h-full object-cover" playsInline />
                        <canvas ref={canvasRef} className="hidden" />
                        <div className="scan-line"></div>
                        {error && <div className="absolute inset-0 flex items-center justify-center text-red-400 font-bold bg-black/80 text-center p-6">{error}</div>}
                        {fileProgress && (
                            <div className="absolute bottom-0 left-0 right-0 bg-black/80 p-4">
                                <div className="flex justify-between text-xs text-white mb-1"><span>Direct Transfer...</span><span>{Math.round(fileProgress)}%</span></div>
                                <div className="w-full bg-slate-700 h-2 rounded-full overflow-hidden"><div className="bg-emerald-500 h-full transition-all duration-100" style={{width: `${fileProgress}%`}}></div></div>
                            </div>
                        )}
                    </div>
                    <button onClick={onClose} className="mt-8 bg-slate-800 text-white px-8 py-3 rounded-full font-bold hover:bg-slate-700 transition-colors">Cancel</button>
                </div>
            );
        };

        const DataImporter = ({ onImport, onClose }) => {
            const [text, setText] = useState("");
            const handleFile = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const content = await file.text();
                onImport(content);
            };
            return (
                <div className="fixed inset-0 z-50 bg-black/95 p-6 flex flex-col items-center justify-center">
                    <div className="w-full max-w-md glass p-6 rounded-2xl">
                        <h2 className="text-white text-xl font-bold mb-4 flex items-center gap-2"><Icon p={icons.import} /> Manual Input</h2>
                        <textarea value={text} onChange={e=>setText(e.target.value)} className="w-full h-32 bg-slate-900 border border-slate-700 text-white p-3 rounded-xl mb-4 font-mono text-xs focus:border-cyan-500 outline-none" placeholder="Paste Encrypted Packet here..."></textarea>
                        <div className="flex items-center gap-2 mb-4">
                            <span className="text-slate-500 text-xs">OR Upload:</span>
                            <input type="file" onChange={handleFile} className="text-white text-xs"/>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <button onClick={onClose} className="bg-slate-700 text-white py-3 rounded-xl font-bold hover:bg-slate-600">Cancel</button>
                            <button onClick={() => onImport(text)} className="bg-cyan-600 text-white py-3 rounded-xl font-bold hover:bg-cyan-500">Process</button>
                        </div>
                    </div>
                </div>
            )
        };

        // --- HACKING TERMINAL FOR DARTH ---
        const HackingTerminal = ({ targetData, onClose }) => {
            const [logs, setLogs] = useState(["> INITIALIZING CRYPTANALYSIS SUITE..."]);
            const [progress, setProgress] = useState(0);
            const [cracking, setCracking] = useState(true);
            const [displayContent, setDisplayContent] = useState(null);

            useEffect(() => {
                let steps = [];
                let content = "";
                let type = "UNKNOWN";

                if (targetData.includes('"e":')) {
                    type = "IDENTITY (PUBLIC KEY)";
                    steps = [
                        "Captured Public Key Block...",
                        "Calculating Elliptic Curve Order (P-256)...",
                        "Attempting Discrete Logarithm Attack...",
                        "Running Pollard's Rho Algorithm...",
                        "Brute forcing Private Scalar...",
                        "Complexity: 2^128 operations required...",
                        "Estimated time: 4 Billion Years...",
                        "FAILED: Key is mathematically secure."
                    ];
                    content = JSON.parse(targetData).e.substring(0, 50) + "...";
                } else if (targetData.includes('"iv":')) {
                    type = "ENCRYPTED MESSAGE";
                    steps = [
                        "Captured AES-GCM Packet...",
                        "Extracting IV and Auth Tag...",
                        "Checking for Key Reuse...",
                        "Attempting Padding Oracle Attack...",
                        "Brute Forcing Key Space (2^256)...",
                        "Progress: 0.0000000000001%...",
                        "ERROR: Integrity Check Failed.",
                        "FAILED: Missing Shared Secret."
                    ];
                    const p = JSON.parse(targetData);
                    content = `IV: ${p.iv}\nCIPHER: ${p.d.substring(0, 20)}...`;
                } else if (targetData.startsWith("F|")) {
                    type = "FILE STREAM";
                    steps = [
                        "Intercepting Data Stream...",
                        "Reassembling Packets...",
                        "Detected Binary Blob...",
                        "Attempting Entropy Analysis...",
                        "Decrypting without Key...",
                        "OUTPUT: Garbage Data",
                        "FAILED: Encryption Robust."
                    ];
                    content = "BINARY_STREAM_CAPTURED";
                }

                let stepIndex = 0;
                const timer = setInterval(() => {
                    if (stepIndex < steps.length) {
                        setLogs(prev => [...prev, `> ${steps[stepIndex]}`]);
                        setProgress(((stepIndex + 1) / steps.length) * 100);
                        stepIndex++;
                    } else {
                        clearInterval(timer);
                        setCracking(false);
                        setDisplayContent(content);
                    }
                }, 800);
                return () => clearInterval(timer);
            }, [targetData]);

            return (
                <div className="fixed inset-0 z-50 bg-black/95 flex flex-col items-center justify-center p-4 font-mono">
                    <div className="w-full max-w-lg bg-slate-900 border-2 border-red-600 rounded-xl overflow-hidden shadow-[0_0_50px_rgba(220,38,38,0.5)]">
                        <div className="bg-red-900/30 p-3 border-b border-red-600 flex justify-between items-center">
                            <span className="text-red-500 font-bold animate-pulse">â˜ ï¸ INTERCEPTOR CONSOLE</span>
                            <span className="text-xs text-red-400">TARGET ACQUIRED</span>
                        </div>
                        <div className="h-64 p-4 overflow-y-auto space-y-2 font-mono text-xs text-green-400 bg-black">
                            {logs.map((l, i) => <div key={i}>{l}</div>)}
                            {cracking && <div className="animate-pulse">_</div>}
                        </div>
                        
                        {!cracking && (
                            <div className="p-4 bg-slate-900 border-t border-red-900/50 text-center">
                                <div className="text-xs text-slate-500 mb-2">CAPTURED PAYLOAD (ENCRYPTED)</div>
                                <div className="bg-black p-2 rounded text-red-500 text-xs break-all mb-4 border border-red-900">
                                    {displayContent}
                                </div>
                                <div className="text-red-500 font-bold mb-4">ACCESS DENIED</div>
                                <button onClick={onClose} className="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-lg">
                                    CLOSE TERMINAL
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [isDarth, setIsDarth] = useState(false);
            const [activeTab, setActiveTab] = useState('CONNECT');
            const [myKeyPair, setMyKeyPair] = useState(null);
            const [myIdentity, setMyIdentity] = useState("");
            const [sharedKey, setSharedKey] = useState(null);
            const [fingerprint, setFingerprint] = useState("????");
            const [scanner, setScanner] = useState(null);
            const [packet, setPacket] = useState(null);
            const [chat, setChat] = useState([]);
            const [msg, setMsg] = useState("");
            const [fileTransfer, setFileTransfer] = useState(null);
            const [incomingFile, setIncomingFile] = useState({ id: null, chunks: {}, total: 0 });
            
            // Full Duplex State
            const [isBroadcasting, setIsBroadcasting] = useState(false);
            const [broadcastId, setBroadcastId] = useState(null);
            const stopBroadcastRef = useRef(null);
            
            const [cheatBuffer, setCheatBuffer] = useState("");
            const [bluetoothUnlocked, setBluetoothUnlocked] = useState(false);
            
            // Darth State
            const [interceptedData, setInterceptedData] = useState(null);
            const [fakeMsg, setFakeMsg] = useState("YOU HAVE BEEN HACKED");
            const [fakePacket, setFakePacket] = useState(null);

            // CHEAT CODE LISTENER
            useEffect(() => {
                const handleKeyDown = (e) => {
                    setCheatBuffer(prev => (prev + e.key).slice(-10).toLowerCase());
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, []);

            useEffect(() => {
                if (cheatBuffer.endsWith("red")) {
                    setIsDarth(true);
                    setCheatBuffer(""); 
                    alert("ğŸ›‘ DARTH MODE UNLOCKED ğŸ›‘");
                }
                if (cheatBuffer.endsWith("blue")) {
                    setBluetoothUnlocked(true);
                    setCheatBuffer("");
                    alert("ğŸ”µ BLUETOOTH/SYSTEM SHARE UNLOCKED ğŸ”µ");
                }
            }, [cheatBuffer]);

            // 1. IDENTITY
            const genKeys = async () => {
                const k = await window.crypto.subtle.generateKey({name:"ECDH", namedCurve:"P-256"}, true, ["deriveKey", "deriveBits"]);
                const exp = await window.crypto.subtle.exportKey("spki", k.publicKey);
                const str = btoa(String.fromCharCode(...new Uint8Array(exp)));
                const json = JSON.stringify({e:str}); // Minimized for audio
                setMyKeyPair(k);
                setMyIdentity(json);
                setSharedKey(null);
                setFingerprint("????");
                setIncomingFile({ id: null, chunks: {}, total: 0 });
            };
            useEffect(() => { genKeys(); }, []);

            // 2. EXCHANGE & DATA HANDLING
            const handleData = async (dataPayload) => {
                if (isDarth) {
                    setInterceptedData(JSON.stringify(dataPayload));
                    setScanner(null);
                    return;
                }

                // If receiving an ACK, we don't process it here, AudioListener handles logic.
                // We just handle 'D' type packets (Data)
                try {
                    const dataStr = typeof dataPayload === 'string' ? dataPayload : JSON.stringify(dataPayload);
                    let payload;
                    
                    try { payload = JSON.parse(dataStr); } 
                    catch(e) { 
                        // QR might not be JSON wrapped with t:'D'
                        if (dataStr.startsWith('F|')) { // File chunk
                             // ... existing file logic ...
                             return;
                        }
                        if (dataStr.includes('"iv":')) payload = { t: 'D', i: '0000', d: JSON.parse(dataStr) }; // Legacy Msg
                        else payload = { t: 'D', i: '0000', d: { e: dataStr } }; // Legacy Identity (Raw base64)
                    }

                    // Process Payload.d
                    const content = payload.d;
                    
                    // A. Identity Exchange
                    if (content.e) {
                        const ab = Uint8Array.from(atob(content.e), c => c.charCodeAt(0)).buffer;
                        const pk = await window.crypto.subtle.importKey("spki", ab, {name:"ECDH", namedCurve:"P-256"}, true, []);
                        const sk = await window.crypto.subtle.deriveKey({name:"ECDH", public:pk}, myKeyPair.privateKey, {name:"AES-GCM", length:256}, true, ["encrypt","decrypt"]);
                        const raw = await window.crypto.subtle.exportKey("raw", sk);
                        const fp = await generateFingerprint(raw);
                        setSharedKey(sk);
                        setFingerprint(fp);
                        setActiveTab('VERIFY');
                        setScanner(null);
                        
                        // AUTO ACK!
                        if (payload.i && payload.i !== '0000') {
                            // Play ACK sound
                            const ackJson = JSON.stringify({ t: 'A', i: payload.i });
                            await SonicTransmitter.play(ackJson, false);
                        } else {
                            alert("Handshake Complete!");
                        }
                    } 
                    // B. Message
                    else if (content.iv) {
                        if(!sharedKey) { 
                            alert("Connect First!"); 
                            setScanner(null); 
                            return; 
                        }
                        const dec = await window.crypto.subtle.decrypt({name:"AES-GCM", iv:hex2buf(content.iv)}, sharedKey, hex2buf(content.d));
                        const txt = new TextDecoder().decode(dec);
                        setChat(prev => [...prev, {from:'Partner', text:txt}]);
                        setScanner(null);
                        
                        if (payload.i && payload.i !== '0000') {
                            const ackJson = JSON.stringify({ t: 'A', i: payload.i });
                            await SonicTransmitter.play(ackJson, false);
                        } else {
                            alert("Received: " + txt);
                        }
                    }

                } catch(e) { 
                    console.error(e);
                    alert("Scan Failed: " + e.message);
                }
            };

            // 3. SEND MSG
            const send = async () => {
                if(!sharedKey || !msg) return;
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const enc = await window.crypto.subtle.encrypt({name:"AES-GCM", iv}, sharedKey, new TextEncoder().encode(msg));
                const pkt = JSON.stringify({iv:buf2hex(iv), d:buf2hex(enc)});
                setPacket(pkt);
                setChat(prev => [...prev, {from:'Me', text:msg}]);
                setMsg("");
            };

            // 4. SEND FILE (Existing logic kept for QR) ...

            // --- SONIC BROADCAST LOGIC ---
            const startBroadcast = async (dataPayload) => {
                if (isBroadcasting) {
                    if (stopBroadcastRef.current) stopBroadcastRef.current();
                    setIsBroadcasting(false);
                    return;
                }

                // Generate Session ID
                const sessionId = Math.floor(Math.random() * 9000 + 1000).toString();
                setBroadcastId(sessionId);
                setIsBroadcasting(true);

                // Wrap data
                const wrapped = JSON.stringify({
                    t: 'D',
                    i: sessionId,
                    d: dataPayload // The Identity or Message object
                });

                // Start Loop
                const stopFn = await SonicTransmitter.play(wrapped, true);
                stopBroadcastRef.current = stopFn;
            };

            const handleAckReceived = () => {
                if (stopBroadcastRef.current) stopBroadcastRef.current();
                setIsBroadcasting(false);
                setBroadcastId(null);
                alert("Transfer Confirmed by Receiver!");
            };

            // RENDER
            return (
                <div className={`min-h-screen flex flex-col ${isDarth ? 'bg-red-950 border-4 border-red-600' : ''}`}>
                    {/* HEADER */}
                    <header className={`p-4 flex justify-between items-center shadow-lg ${isDarth ? 'bg-red-900' : 'bg-slate-900'}`}>
                        <div className="flex items-center gap-2 text-white font-bold">
                            <Icon p={isDarth ? icons.skull : icons.shield} /> 
                            <span>CryptoVis {isDarth && "DARTH"}</span>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={genKeys}><Icon p={icons.refresh}/></button>
                        </div>
                    </header>

                    {/* TABS */}
                    <div className="flex bg-slate-800 text-xs font-bold text-slate-400">
                        {['CONNECT','VERIFY','CHAT'].map(t => (
                            <button key={t} onClick={()=>setActiveTab(t)} className={`flex-1 py-3 ${activeTab===t ? 'text-cyan-400 bg-slate-700' : ''}`}>{t}</button>
                        ))}
                    </div>

                    <main className="flex-1 p-4 space-y-6 max-w-md mx-auto w-full">
                        
                        {/* CONNECT TAB */}
                        {activeTab === 'CONNECT' && (
                            <div className="glass p-6 rounded-xl text-center space-y-4 animate-in fade-in">
                                <h2 className="text-white font-bold">Exchange Identities</h2>
                                <div className="flex justify-center"><QRDisplay data={myIdentity} label="My Identity" /></div>
                                
                                <div className="grid grid-cols-2 gap-2">
                                    <button onClick={() => startBroadcast(JSON.parse(myIdentity))} className={`btn-primary ${isBroadcasting ? 'bg-red-600 animate-pulse' : 'bg-purple-600'}`}>
                                        <Icon p={icons.sound} /> {isBroadcasting ? 'Broadcasting...' : 'SonicLink'}
                                    </button>
                                    <button onClick={() => setScanner('QR')} className="btn-primary">
                                        <Icon p={icons.cam} /> Scan QR
                                    </button>
                                </div>
                                <div className="grid grid-cols-1 gap-2 mt-2">
                                     <button onClick={() => setScanner('AUDIO')} className="btn-secondary bg-purple-900/50 hover:bg-purple-900 border border-purple-500">
                                        <Icon p={icons.mic}/> Receive SonicLink (Listen)
                                    </button>
                                </div>
                                {isBroadcasting && (
                                    <div className="text-xs text-emerald-400 bg-emerald-900/20 p-2 rounded border border-emerald-500/50 flex flex-col items-center gap-1">
                                        <Icon p={icons.mic} size={16}/>
                                        <span>Listening for ACK ({broadcastId})...</span>
                                        <AudioListener onData={handleAckReceived} expectedType="ACK" autoAckId={broadcastId} onClose={()=>{}} />
                                    </div>
                                )}
                            </div>
                        )}

                        {/* VERIFY TAB */}
                        {activeTab === 'VERIFY' && (
                            <div className="glass p-6 rounded-xl text-center space-y-4 animate-in fade-in">
                                <h2 className="text-yellow-400 font-bold uppercase">Safety Fingerprint</h2>
                                {sharedKey ? (
                                    <>
                                        <div className="bg-slate-900 p-4 rounded-xl text-4xl">{fingerprint}</div>
                                        <p className="text-slate-400 text-sm">Does this match your partner's screen?</p>
                                        <div className="text-xs text-slate-500 mt-4">Partner didn't scan you yet?</div>
                                        <div className="flex justify-center"><QRDisplay data={myIdentity} label="Show to Partner" /></div>
                                        <button onClick={() => startBroadcast(JSON.parse(myIdentity))} className={`w-full ${isBroadcasting ? 'bg-red-600' : 'bg-purple-600'} text-white py-2 rounded font-bold flex items-center justify-center gap-2`}>
                                            <Icon p={icons.sound}/> {isBroadcasting ? 'Stop' : 'Send ID via SonicLink'}
                                        </button>
                                    </>
                                ) : <div className="text-red-400">Connect First</div>}
                            </div>
                        )}

                        {/* CHAT TAB */}
                        {activeTab === 'CHAT' && (
                            <div className="space-y-4 animate-in fade-in">
                                <div className="glass h-48 overflow-y-auto p-4 space-y-2 rounded-xl">
                                    {chat.length===0 && <div className="text-slate-500 text-center text-sm">Secure Channel Ready</div>}
                                    {chat.map((c,i) => (
                                        <div key={i} className={`text-sm p-2 rounded ${c.from==='Me'?'bg-cyan-900/50 ml-auto text-right':'bg-slate-700'}`}>
                                            <span className="text-xs opacity-50 block">{c.from}</span>
                                            {c.text}
                                        </div>
                                    ))}
                                </div>
                                <div className="flex gap-2">
                                    <input value={msg} onChange={e=>setMsg(e.target.value)} className="flex-1 bg-slate-800 rounded px-3 text-white" placeholder="Message..." />
                                    <button onClick={send} className="bg-cyan-600 px-3 py-2 rounded text-white"><Icon p={icons.send}/></button>
                                </div>
                                
                                {packet && (
                                    <div className="glass p-4 rounded-xl text-center space-y-3">
                                        <div className="text-xs text-slate-400">Encrypted Packet Ready</div>
                                        <div className="flex justify-center"><QRDisplay data={packet} label="Scan Packet" /></div>
                                        
                                        <div className="grid grid-cols-1 gap-2">
                                            <button onClick={()=>startBroadcast(JSON.parse(packet))} className={`btn-primary ${isBroadcasting ? 'bg-red-600' : 'bg-purple-600'}`}>
                                                <Icon p={icons.sound}/> {isBroadcasting ? 'Broadcasting...' : 'SonicLink'}
                                            </button>
                                        </div>
                                    </div>
                                )}
                                {isBroadcasting && (
                                    <div className="text-xs text-emerald-400 bg-emerald-900/20 p-2 rounded border border-emerald-500/50 flex flex-col items-center gap-1">
                                        <span>Listening for ACK...</span>
                                        <AudioListener onData={handleAckReceived} expectedType="ACK" autoAckId={broadcastId} onClose={()=>{}} />
                                    </div>
                                )}

                                <div className="grid grid-cols-2 gap-2">
                                    <button onClick={() => setScanner('AUDIO')} className="bg-purple-900/50 hover:bg-purple-900 text-purple-200 py-3 rounded font-bold flex items-center justify-center gap-2 border border-purple-500">
                                        <Icon p={icons.mic}/> Listen
                                    </button>
                                    <button onClick={() => setScanner('QR')} className="bg-slate-700 hover:bg-slate-600 text-white py-3 rounded font-bold flex items-center justify-center gap-2">
                                        <Icon p={icons.cam}/> Scan
                                    </button>
                                </div>
                                {bluetoothUnlocked && (
                                    <button onClick={() => setScanner('IMPORT')} className="w-full bg-slate-800 hover:bg-slate-700 text-white py-3 rounded font-bold flex items-center justify-center gap-2 animate-in fade-in">
                                        <Icon p={icons.import}/> Import / Paste Packet
                                    </button>
                                )}
                            </div>
                        )}
                    </main>

                    {/* MODALS */}
                    {scanner === 'QR' && <QRScanner onScan={d => { handleData(d); }} onClose={()=>setScanner(null)} />}
                    {scanner === 'AUDIO' && <AudioListener onClose={()=>setScanner(null)} onData={d => { setScanner(null); handleData(d); }} />}
                    {scanner === 'IMPORT' && <DataImporter onClose={()=>setScanner(null)} onImport={d => { setScanner(null); handleData(d); }} />}
                    {fileTransfer && <AnimatedQR chunks={fileTransfer.chunks} label="Broadcasting File" onClose={()=>setFileTransfer(null)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
