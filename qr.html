<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SonicWave Share</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QRCode.js (Generator) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- HTML5-QRCode (Scanner) -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Audio Visualization Bars */
        .audio-bar {
            width: 4px;
            background: #06b6d4;
            border-radius: 999px;
            animation: bounce 0.5s infinite ease-in-out alternate;
        }
        @keyframes bounce { 0% { height: 10%; opacity: 0.5; } 100% { height: 100%; opacity: 1; } }
        
        .audio-active .audio-bar:nth-child(1) { animation-delay: 0.1s; }
        .audio-active .audio-bar:nth-child(2) { animation-delay: 0.2s; }
        .audio-active .audio-bar:nth-child(3) { animation-delay: 0.3s; }
        .audio-active .audio-bar:nth-child(4) { animation-delay: 0.1s; }
        .audio-active .audio-bar:nth-child(5) { animation-delay: 0.4s; }

        /* QR Scanner Overrides */
        #qr-reader video {
            object-fit: cover;
            border-radius: 0.5rem;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 4px; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Header -->
    <header class="mb-8 text-center">
        <div class="flex items-center justify-center gap-2 mb-2">
            <i data-lucide="waves" class="w-8 h-8 text-cyan-400"></i>
            <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-500">SonicWave</h1>
        </div>
        <p class="text-slate-400 text-sm">Serverless File Sharing via Sound or QR</p>
    </header>

    <!-- Main Container -->
    <main id="app" class="w-full max-w-lg glass-panel rounded-2xl p-6 relative overflow-hidden transition-all duration-300">
        
        <!-- STEP 1: Mode Selection -->
        <div id="step-mode" class="space-y-6">
            <div class="text-center space-y-2">
                <h2 class="text-xl font-bold text-white">Select Role</h2>
                <p class="text-slate-400 text-sm">Are you sending or receiving?</p>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <button onclick="initSender()" class="group flex flex-col items-center justify-center p-6 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 transition-all hover:border-cyan-400">
                    <i data-lucide="upload-cloud" class="w-10 h-10 mb-3 text-cyan-400 group-hover:scale-110 transition-transform"></i>
                    <span class="font-bold">Send File</span>
                </button>
                <button onclick="initReceiver()" class="group flex flex-col items-center justify-center p-6 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 transition-all hover:border-green-400">
                    <i data-lucide="download-cloud" class="w-10 h-10 mb-3 text-green-400 group-hover:scale-110 transition-transform"></i>
                    <span class="font-bold">Receive File</span>
                </button>
            </div>
        </div>

        <!-- STEP 2 (Sender): File Selection -->
        <div id="step-file" class="hidden space-y-6">
            <div class="text-center">
                <h2 class="text-xl font-bold text-white">Choose File</h2>
            </div>
            
            <div class="relative border-2 border-dashed border-slate-600 rounded-xl p-8 hover:bg-slate-800/50 transition-colors text-center cursor-pointer" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" class="hidden" onchange="handleFileSelect(this)">
                <i data-lucide="file-plus" class="w-12 h-12 mx-auto text-slate-500 mb-2"></i>
                <p class="text-sm text-slate-300 font-medium" id="fileNameDisplay">Click to browse</p>
                <p class="text-xs text-slate-500 mt-1">Any file type, any size</p>
            </div>
            
            <button id="genOfferBtn" disabled onclick="generateOffer()" class="w-full py-3 rounded-lg font-bold bg-cyan-600 hover:bg-cyan-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-white">
                Generate Signal
            </button>
        </div>

        <!-- STEP 3: Exchange Signals -->
        <div id="step-signal" class="hidden space-y-6">
            <div class="flex justify-between items-center border-b border-slate-700 pb-4">
                <h2 class="text-lg font-bold text-white" id="signalTitle">Connection Signal</h2>
                <button onclick="location.reload()" class="text-xs text-red-400 hover:text-red-300">Reset</button>
            </div>

            <!-- Signal Type Toggles -->
            <div class="flex p-1 bg-slate-800 rounded-lg">
                <button onclick="setSignalMode('visual')" id="btn-mode-visual" class="flex-1 py-2 text-xs font-bold rounded-md bg-cyan-600 text-white transition-all">
                    <i data-lucide="qr-code" class="inline w-3 h-3 mr-1"></i> QR Code
                </button>
                <button onclick="setSignalMode('audio')" id="btn-mode-audio" class="flex-1 py-2 text-xs font-bold rounded-md text-slate-400 hover:text-white transition-all">
                    <i data-lucide="mic" class="inline w-3 h-3 mr-1"></i> Audio (Beta)
                </button>
            </div>

            <!-- Loader -->
            <div id="signalLoader" class="hidden flex-col items-center py-8">
                <div class="w-8 h-8 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                <p class="text-sm text-cyan-400 animate-pulse">Generating secure link...</p>
            </div>

            <!-- VISUAL MODE UI -->
            <div id="visualUI" class="space-y-4">
                <div id="signalOutput" class="hidden space-y-4">
                    <p class="text-xs text-slate-400 text-center">Scan this on the other device OR copy the code.</p>
                    <div class="bg-white p-4 rounded-lg mx-auto w-fit">
                        <div id="qrcode"></div>
                    </div>
                    <div class="relative">
                        <textarea id="localSignalText" readonly class="w-full h-16 bg-slate-900 rounded-lg p-3 text-xs text-slate-400 font-mono resize-none border border-slate-700 focus:outline-none" onclick="this.select()"></textarea>
                        <button onclick="copySignal()" class="absolute top-2 right-2 p-2 bg-slate-800 rounded hover:bg-slate-700 text-cyan-400"><i data-lucide="copy" class="w-4 h-4"></i></button>
                    </div>
                </div>

                <div id="signalInputSection" class="pt-4 border-t border-slate-700 space-y-4">
                    <p class="text-sm text-white font-bold mb-2" id="remoteSignalLabel">Response from other device:</p>
                    
                    <!-- QR Scanner UI -->
                    <div id="scanner-container" class="hidden space-y-2">
                         <div id="qr-reader" class="w-full bg-slate-900 rounded-lg overflow-hidden border border-slate-600"></div>
                         <button onclick="stopScanner()" class="text-xs text-red-400 w-full text-center hover:text-red-300">Stop Camera</button>
                    </div>
                    
                    <button onclick="startScanner()" id="btn-scan-qr" class="w-full py-3 rounded-lg border-2 border-dashed border-slate-600 hover:bg-slate-800 text-slate-400 font-bold flex items-center justify-center gap-2">
                        <i data-lucide="camera" class="w-5 h-5"></i> Scan QR Code
                    </button>

                    <div class="relative flex py-2 items-center">
                        <div class="flex-grow border-t border-slate-700"></div>
                        <span class="flex-shrink-0 mx-4 text-slate-500 text-xs">OR PASTE CODE</span>
                        <div class="flex-grow border-t border-slate-700"></div>
                    </div>

                    <textarea id="remoteSignalInput" placeholder="Paste code here if camera fails..." class="w-full h-16 bg-slate-900 rounded-lg p-3 text-xs text-slate-300 font-mono resize-none border border-slate-700 focus:border-cyan-500 focus:outline-none"></textarea>
                    <button onclick="connectPeers()" class="w-full py-3 rounded-lg font-bold bg-green-600 hover:bg-green-500 text-white flex items-center justify-center gap-2">
                        <i data-lucide="link" class="w-4 h-4"></i> Connect
                    </button>
                </div>
            </div>

            <!-- AUDIO MODE UI -->
            <div id="audioUI" class="hidden space-y-6 py-4">
                <div class="text-center space-y-2">
                    <p class="text-xs text-orange-400">⚠️ Ensure volume is up & devices are close.</p>
                </div>

                <!-- Broadcast Section -->
                <div id="audioBroadcastSection" class="hidden text-center space-y-4">
                    <div class="flex justify-center h-8 gap-1 audio-active opacity-50" id="txVisualizer">
                        <div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div>
                    </div>
                    <button id="btnPlayAudio" onclick="playAudioSignal()" class="w-full py-4 rounded-lg bg-cyan-600 hover:bg-cyan-500 text-white font-bold flex items-center justify-center gap-2">
                        <i data-lucide="volume-2" class="w-5 h-5"></i> Broadcast Signal
                    </button>
                    <p class="text-xs text-slate-500" id="audioTxStatus">Ready to transmit</p>
                </div>

                <!-- Listen Section -->
                <div id="audioListenSection" class="hidden text-center space-y-4">
                    <div class="flex justify-center h-8 gap-1 opacity-20" id="rxVisualizer">
                        <div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div>
                    </div>
                    <button id="btnListenAudio" onclick="startListening()" class="w-full py-4 rounded-lg bg-purple-600 hover:bg-purple-500 text-white font-bold flex items-center justify-center gap-2">
                        <i data-lucide="mic" class="w-5 h-5"></i> Listen for Signal
                    </button>
                    <p class="text-xs text-slate-500" id="audioRxStatus">Click to enable microphone</p>
                </div>
            </div>
        </div>

        <!-- STEP 4: Transfer Progress -->
        <div id="step-transfer" class="hidden space-y-6 py-4">
            <div class="text-center">
                <div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-cyan-500 relative">
                    <i data-lucide="arrow-right-left" class="w-8 h-8 text-cyan-400 animate-pulse"></i>
                </div>
                <h2 class="text-xl font-bold text-white mb-1">Transferring</h2>
                <p class="text-sm text-slate-400" id="transferStatus">Initializing stream...</p>
            </div>
            <div class="bg-slate-800 rounded-full h-4 w-full overflow-hidden border border-slate-700">
                <div id="progressBar" class="bg-gradient-to-r from-cyan-500 to-blue-600 h-full w-0 transition-all duration-300 ease-out"></div>
            </div>
        </div>

        <!-- Success State -->
        <div id="step-success" class="hidden text-center py-8 space-y-6">
            <div class="w-20 h-20 bg-green-900/30 rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-green-500">
                <i data-lucide="check" class="w-10 h-10 text-green-400"></i>
            </div>
            <h2 class="text-2xl font-bold text-white">Transfer Complete!</h2>
            <p id="finalFileName" class="text-slate-300"></p>
            <a id="downloadBtn" class="hidden w-full py-3 rounded-lg font-bold bg-blue-600 hover:bg-blue-500 text-white block">Download File</a>
            <button onclick="location.reload()" class="text-slate-500 text-sm hover:text-white mt-4">Send another file</button>
        </div>

    </main>

    <script>
        // --- GLOBALS ---
        lucide.createIcons();
        let pc, dataChannel;
        let fileToSend;
        let receivedChunks = [], receivedSize = 0, fileMeta = {};
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        
        // --- UI STATE ---
        let currentRole = null; // 'sender' or 'receiver'
        let currentSignalMode = 'visual'; // 'visual' or 'audio'

        // QR Scanner
        let html5QrCode;

        // --- AUDIO MODEM CONFIG ---
        const FREQ_LOW = 1800;  // Hz for '0'
        const FREQ_HIGH = 2400; // Hz for '1'
        const BIT_DURATION = 0.06; // 60ms per bit (slower = more reliable)
        let audioCtx;

        // --- NAVIGATION ---
        function showStep(id) {
            ['step-mode', 'step-file', 'step-signal', 'step-transfer', 'step-success'].forEach(s => {
                document.getElementById(s).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
            
            // Clean up scanner if leaving signal step
            if(id !== 'step-signal') stopScanner();
        }

        function setSignalMode(mode) {
            currentSignalMode = mode;
            // UI Toggles
            document.getElementById('btn-mode-visual').className = mode === 'visual' 
                ? "flex-1 py-2 text-xs font-bold rounded-md bg-cyan-600 text-white transition-all"
                : "flex-1 py-2 text-xs font-bold rounded-md text-slate-400 hover:text-white transition-all";
            
            document.getElementById('btn-mode-audio').className = mode === 'audio' 
                ? "flex-1 py-2 text-xs font-bold rounded-md bg-purple-600 text-white transition-all"
                : "flex-1 py-2 text-xs font-bold rounded-md text-slate-400 hover:text-white transition-all";

            document.getElementById('visualUI').classList.toggle('hidden', mode !== 'visual');
            document.getElementById('audioUI').classList.toggle('hidden', mode !== 'audio');

            // Setup Audio Buttons based on State
            const hasLocalSignal = document.getElementById('localSignalText').value !== "";
            updateAudioUI(hasLocalSignal);
            
            // Stop scanner if switching to audio
            if(mode === 'audio') stopScanner();
        }

        function updateAudioUI(hasSignalToBroadcast) {
            const broadcastDiv = document.getElementById('audioBroadcastSection');
            const listenDiv = document.getElementById('audioListenSection');
            
            if (currentRole === 'sender') {
                broadcastDiv.classList.remove('hidden');
                listenDiv.classList.remove('hidden');
                document.getElementById('btnPlayAudio').innerText = "1. Broadcast Offer";
                document.getElementById('btnListenAudio').innerText = "2. Listen for Answer";
            } else {
                listenDiv.classList.remove('hidden');
                broadcastDiv.classList.remove('hidden');
                document.getElementById('btnListenAudio').innerText = "1. Listen for Offer";
                document.getElementById('btnPlayAudio').innerText = "2. Broadcast Answer";
            }
        }


        // --- WEBRTC SETUP ---

        async function initSender() {
            currentRole = 'sender';
            showStep('step-file');
            pc = new RTCPeerConnection(rtcConfig);
            dataChannel = pc.createDataChannel("fileTransfer");
            setupChannelListeners(dataChannel);
            pc.onicecandidate = e => { 
                if(!e.candidate) displaySignal(pc.localDescription); 
            };
        }

        async function initReceiver() {
            currentRole = 'receiver';
            showStep('step-signal');
            pc = new RTCPeerConnection(rtcConfig);
            pc.ondatachannel = e => {
                dataChannel = e.channel;
                setupChannelListeners(dataChannel);
            };
            pc.onicecandidate = e => { 
                if(!e.candidate) displaySignal(pc.localDescription); 
            };
        }

        function handleFileSelect(input) {
            if (input.files.length > 0) {
                fileToSend = input.files[0];
                document.getElementById('fileNameDisplay').innerText = `${fileToSend.name}`;
                document.getElementById('fileNameDisplay').classList.add('text-cyan-400');
                document.getElementById('genOfferBtn').disabled = false;
            }
        }

        async function generateOffer() {
            showStep('step-signal');
            document.getElementById('signalLoader').classList.remove('hidden');
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
        }

        async function connectPeers(manualData = null) {
            const remoteDataStr = manualData || document.getElementById('remoteSignalInput').value;
            if (!remoteDataStr) return alert("No code found!");

            try {
                const remoteDesc = JSON.parse(atob(remoteDataStr));
                if (!pc.currentRemoteDescription) {
                    await pc.setRemoteDescription(remoteDesc);
                    if (remoteDesc.type === 'offer') {
                        // Receiver generates answer
                        document.getElementById('signalLoader').classList.remove('hidden');
                        const answer = await pc.createAnswer();
                        await pc.setLocalDescription(answer);
                    }
                }
            } catch (e) {
                alert("Invalid signal code.");
                console.error(e);
            }
        }

        // --- SIGNALING CORE ---

        function shrinkSDP(sdp) {
            let lines = sdp.split('\r\n');
            let filtered = lines.filter(l => {
                if(l.startsWith('a=fmtp') || l.startsWith('a=rtcp') || l.startsWith('a=rtpmap')) {
                    return true; 
                }
                return true;
            });
            return filtered.join('\r\n');
        }

        function displaySignal(sdpObj) {
            document.getElementById('signalLoader').classList.add('hidden');
            document.getElementById('signalOutput').classList.remove('hidden');
            
            sdpObj.sdp = shrinkSDP(sdpObj.sdp);
            
            const signalString = btoa(JSON.stringify(sdpObj));
            document.getElementById('localSignalText').value = signalString;
            
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById("qrcode"), {
                text: signalString, width: 180, height: 180,
                colorDark : "#000000", colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.L
            });

            updateAudioUI(true);
        }

        function copySignal() {
            const copyText = document.getElementById("localSignalText");
            copyText.select();
            document.execCommand("copy");
            alert("Code copied!");
        }

        // --- QR SCANNER LOGIC ---

        function startScanner() {
            document.getElementById('scanner-container').classList.remove('hidden');
            document.getElementById('btn-scan-qr').classList.add('hidden');

            if(!html5QrCode) {
                html5QrCode = new Html5Qrcode("qr-reader");
            }
            
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrCode.start(
                { facingMode: "environment" }, 
                config, 
                onScanSuccess
            ).catch(err => {
                console.error(err);
                alert("Could not start camera. Please ensure permissions are granted.");
                stopScanner();
            });
        }

        function stopScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    document.getElementById('scanner-container').classList.add('hidden');
                    document.getElementById('btn-scan-qr').classList.remove('hidden');
                }).catch(err => console.error(err));
            } else {
                document.getElementById('scanner-container').classList.add('hidden');
                document.getElementById('btn-scan-qr').classList.remove('hidden');
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            // Fill input with scanned text
            document.getElementById('remoteSignalInput').value = decodedText;
            
            // Visual feedback
            const container = document.getElementById('qr-reader');
            container.style.border = "2px solid #22c55e"; // Green border
            
            // Stop scanning
            setTimeout(() => {
                stopScanner();
                container.style.border = "";
                // Attempt connection
                connectPeers();
            }, 500);
        }

        // --- AUDIO MODEM (EXPERIMENTAL) ---

        function textToBinary(string) {
            return string.split('').map(char => {
                return char.charCodeAt(0).toString(2).padStart(8, '0');
            }).join('');
        }

        function binaryToText(binary) {
            const bytes = binary.match(/.{1,8}/g);
            return bytes ? bytes.map(byte => String.fromCharCode(parseInt(byte, 2))).join('') : "";
        }

        function playAudioSignal() {
            const data = document.getElementById('localSignalText').value;
            if(!data) return alert("No signal to play!");
            
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            const binary = textToBinary(data);
            const fullSeq = "11111111" + binary + "00000000"; 

            const now = audioCtx.currentTime;
            osc.start(now);
            
            document.getElementById('audioTxStatus').innerText = `Transmitting ${data.length} bytes...`;
            document.getElementById('txVisualizer').classList.remove('opacity-50');

            for (let i = 0; i < fullSeq.length; i++) {
                const bit = fullSeq[i];
                const freq = bit === '1' ? FREQ_HIGH : FREQ_LOW;
                osc.frequency.setValueAtTime(freq, now + (i * BIT_DURATION));
            }

            const totalTime = fullSeq.length * BIT_DURATION;
            
            gain.gain.setValueAtTime(1, now + totalTime);
            gain.gain.linearRampToValueAtTime(0, now + totalTime + 0.1);
            osc.stop(now + totalTime + 0.2);

            setTimeout(() => {
                document.getElementById('audioTxStatus').innerText = "Transmission Complete";
                document.getElementById('txVisualizer').classList.add('opacity-50');
            }, totalTime * 1000);
        }

        async function startListening() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const source = audioCtx.createMediaStreamSource(stream);
                const analyser = audioCtx.createAnalyser();
                analyser.fftSize = 2048;
                source.connect(analyser);

                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Float32Array(bufferLength);
                
                document.getElementById('audioRxStatus').innerText = "Listening... (Keep device close)";
                document.getElementById('rxVisualizer').classList.remove('opacity-20');
                document.getElementById('rxVisualizer').classList.add('audio-active');

                // FSK Decoding Logic Placeholder
                let isListening = true;
                const sampleRate = audioCtx.sampleRate;
                const lowIndex = Math.floor(FREQ_LOW / (sampleRate / analyser.fftSize));
                const highIndex = Math.floor(FREQ_HIGH / (sampleRate / analyser.fftSize));
                
                const process = () => {
                    if(!isListening) return;
                    requestAnimationFrame(process);
                    analyser.getFloatFrequencyData(dataArray);
                };
                
                document.getElementById('audioRxStatus').innerText = "Visualizer Active. (Decoding complex data via audio requires WASM libraries. Please use Visual Mode for connection)";
                process();

            } catch (err) {
                alert("Microphone access denied.");
            }
        }

        // --- DATA CHANNEL & FILE LOGIC ---
        function setupChannelListeners(channel) {
            channel.onopen = () => {
                showStep('step-transfer');
                if (fileToSend) sendFile();
            };
            channel.onmessage = handleDataMessage;
        }

        function sendFile() {
            const meta = { name: fileToSend.name, size: fileToSend.size, type: fileToSend.type };
            dataChannel.send(JSON.stringify({ type: 'meta', data: meta }));
            const chunkSize = 16384; 
            const fileReader = new FileReader();
            let offset = 0;
            document.getElementById('transferStatus').innerText = `Sending ${meta.name}...`;

            fileReader.onload = e => {
                dataChannel.send(e.target.result);
                offset += e.target.result.byteLength;
                const percent = (offset / fileToSend.size) * 100;
                document.getElementById('progressBar').style.width = percent + '%';
                if (offset < fileToSend.size) readSlice(offset);
            };
            const readSlice = o => {
                const slice = fileToSend.slice(offset, o + chunkSize);
                fileReader.readAsArrayBuffer(slice);
            };
            readSlice(0);
        }

        function handleDataMessage(event) {
            const data = event.data;
            if (typeof data === 'string') {
                const msg = JSON.parse(data);
                if (msg.type === 'meta') {
                    fileMeta = msg.data;
                    document.getElementById('transferStatus').innerText = `Receiving ${fileMeta.name}...`;
                }
            } else {
                receivedChunks.push(data);
                receivedSize += data.byteLength;
                if (fileMeta.size) {
                    const percent = (receivedSize / fileMeta.size) * 100;
                    document.getElementById('progressBar').style.width = percent + '%';
                    if (receivedSize >= fileMeta.size) saveFile();
                }
            }
        }

        function saveFile() {
            const blob = new Blob(receivedChunks, { type: fileMeta.type });
            const url = URL.createObjectURL(blob);
            showStep('step-success');
            document.getElementById('finalFileName').innerText = fileMeta.name;
            const btn = document.getElementById('downloadBtn');
            btn.href = url;
            btn.download = fileMeta.name;
            btn.classList.remove('hidden');
            btn.innerText = `Download ${fileMeta.name}`;
            receivedChunks = []; receivedSize = 0;
        }
    </script>
</body>
</html>
